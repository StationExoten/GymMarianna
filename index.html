<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Stile base Material 3 */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f3f3f3; /* Surface Container Low */
            color: #1c1b1f; /* On Surface */
        }
        body.overflow-hidden {
            overflow: hidden;
        }
        .material-card {
            background-color: #fffbfe; /* Surface */
            border-radius: 12px;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.1);
            transition: box-shadow 0.2s ease-in-out, background-color 0.3s ease;
        }
        .material-card:hover {
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.1);
        }
        .material-button {
            border-radius: 20px;
            padding: 10px 24px;
            font-weight: 500;
            text-transform: none;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .material-button-filled {
            background-color: #6750A4; /* Primary */
            color: #ffffff; /* On Primary */
        }
        .material-button-filled:hover:not(:disabled) {
            background-color: #5a4293;
        }
        .material-button-outlined {
            border: 1px solid #79747E; /* Outline */
            color: #6750A4; /* Primary */
        }
        .material-button-outlined:hover:not(:disabled) {
            background-color: rgba(103, 80, 164, 0.08);
        }
         .material-button-text {
            color: #6750A4; /* Primary */
        }
        .material-button-text:hover:not(:disabled) {
            background-color: rgba(103, 80, 164, 0.08);
        }
        .fab {
            background-color: #f2daff; /* Primary Container */
            color: #21005d; /* On Primary Container */
            width: 56px;
            height: 56px;
            border-radius: 16px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        }
        .input-field {
            background-color: #f3f3f3; /* Surface Container Highest */
            border-radius: 4px;
            border: 1px solid #79747E; /* On Surface Variant */
            padding: 16px;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            border: 2px solid #6750A4; /* Primary */
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.32);
        }
        .modal-content {
            background-color: #fffbfe; /* Surface */
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            border-radius: 28px;
        }
        .nav-item {
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .nav-item.active {
            border-color: #6750A4; /* Primary */
            color: #6750A4;
        }
        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-dot.selected {
            border-color: #6750A4;
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px #6750A4;
        }
        .tab-button {
            padding: 8px 16px;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
        }
        .tab-button.active {
            border-color: #6750A4;
            color: #6750A4;
        }
        .sheet-item.deactivated {
            opacity: 0.5;
            background-color: #e0e0e0;
        }
        .sheet-item.done {
            background-color: #e8f5e9; /* Light green */
        }
        .variant-carousel-container {
            position: relative;
            overflow: hidden;
        }
        .variant-carousel-track {
            display: flex;
            transition: transform 0.3s ease-in-out;
        }
        .variant-slide {
            width: 100%;
            flex-shrink: 0;
        }
        .variant-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            z-index: 10;
        }
        .variant-dots {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 8px;
        }
        .variant-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ccc;
            transition: background-color 0.3s;
        }
        .variant-dot.active {
            background-color: #6750A4;
        }
        .sheet-items-list > .sheet-item:not(:first-child) {
            border-top: 1px solid #e0e0e0;
        }


        /* Scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
        .blinking {
            animation: blinker 1s linear infinite;
        }
        @keyframes blinker {
            50% {
                opacity: 0.2;
            }
        }
        .toast {
            transition: opacity 0.3s, transform 0.3s;
        }

        /* Stili per il loader */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #6750A4;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="antialiased">

    <div id="auth-container" class="fixed inset-0 z-[100] flex items-center justify-center bg-gray-100">
        <div class="material-card p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-1">Workout<span class="text-[#6750A4]">Tracker</span></h2>
            <p class="text-center text-gray-500 mb-6">Accedi per continuare</p>
            <div class="space-y-4">
                <input type="email" id="auth-email" placeholder="Email" class="input-field">
                <div class="relative">
                    <input type="password" id="auth-password" placeholder="Password" class="input-field !pr-12">
                    <button id="password-toggle" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-600">
                        <span class="material-icons text-xl">visibility_off</span>
                    </button>
                </div>
            </div>
            <div class="flex flex-col items-center mt-6">
                <button id="login-btn" class="material-button material-button-filled w-full">Accedi</button>
                <button id="register-btn" class="material-button material-button-text mt-4 text-sm">Non hai un account? Registrati</button>
            </div>
            <p id="auth-error" class="text-red-500 text-sm text-center mt-4 h-4"></p>
        </div>
    </div>

    <!-- ===== Contenitore Modalità Allenamento ===== -->
    <div id="workout-mode-container" class="fixed inset-0 z-[80] bg-gray-100 flex-col p-4 hidden">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 id="workout-sheet-name" class="text-xl font-bold">Modalità Allenamento</h2>
                <p id="workout-step-counter" class="text-sm text-gray-600">Passaggio 1 / 10</p>
            </div>
            <div class="flex items-center gap-2">
                 <div id="workout-global-timer" class="text-lg font-mono p-2 bg-white rounded-lg shadow-sm">00:00:00</div>
                 <button id="end-workout-btn-header" class="material-button material-button-outlined !border-red-500 !text-red-500">Termina</button>
            </div>
        </div>

        <div id="workout-item-content" class="flex-1 overflow-y-auto p-2 bg-white rounded-lg shadow-inner">
            <!-- Contenuto del passaggio corrente verrà inserito qui -->
        </div>

        <div id="workout-navigation" class="flex justify-between items-center mt-4">
             <button id="workout-prev-btn" class="material-button material-button-outlined flex items-center gap-2">
                <span class="material-icons">arrow_back</span> Precedente
            </button>
             <button id="workout-next-btn" class="material-button material-button-filled flex items-center gap-2">
                Successivo <span class="material-icons">arrow_forward</span>
            </button>
        </div>
         <div id="workout-finish-view" class="hidden flex-col items-center justify-center text-center p-8">
            <span class="material-icons text-6xl text-green-500">check_circle</span>
            <h3 class="text-2xl font-bold mt-4">Allenamento Completato!</h3>
            <p class="text-gray-600 mt-2">Ottimo lavoro. Premi il pulsante per terminare e salvare la sessione.</p>
            <button id="end-workout-btn-final" class="material-button material-button-filled !bg-green-600 mt-6 !text-lg !px-8 !py-4">Termina e Salva</button>
        </div>
    </div>


    <div id="app-container" class="hidden">
        <header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 shadow-sm">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-xl font-bold text-[#1d192b]">Workout<span class="text-[#6750A4]">Tracker</span></h1>
                    <div class="flex items-center">
                        <nav class="hidden md:flex space-x-4 items-center">
                            <button id="nav-sheets" class="nav-item py-2 px-3 text-gray-600 font-medium">Scheda Allenamento</button>
                            <button id="nav-history" class="nav-item py-2 px-3 text-gray-600 font-medium">Storico e Progressi</button>
                            <button id="nav-db" class="nav-item py-2 px-3 text-gray-600 font-medium">Database Esercizi</button>
                        </nav>
                        <button id="logout-btn" title="Logout" class="material-button-text p-2 rounded-full ml-4"><span class="material-icons">logout</span></button>
                    </div>
                </div>
            </div>
        </header>
        
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-t z-40 border-t">
            <div class="flex justify-around">
                <button id="nav-mobile-sheets" class="flex flex-col items-center justify-center p-2 text-gray-500 nav-item w-full">
                    <span class="material-icons">assignment</span>
                    <span class="text-xs">Schede</span>
                </button>
                <button id="nav-mobile-history" class="flex flex-col items-center justify-center p-2 text-gray-500 nav-item w-full">
                    <span class="material-icons">timeline</span>
                    <span class="text-xs">Storico</span>
                </button>
                <button id="nav-mobile-db" class="flex flex-col items-center justify-center p-2 text-gray-500 nav-item w-full">
                    <span class="material-icons">fitness_center</span>
                    <span class="text-xs">Esercizi</span>
                </button>
            </div>
        </nav>

        <main class="container mx-auto p-4 pb-40 md:pb-24">
            <div id="page-sheets" class="hidden">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h2 class="text-2xl font-medium">Schede Allenamento</h2>
                    <div class="flex gap-2">
                        <button id="add-container-btn" class="material-button material-button-outlined flex items-center gap-2">
                           <span class="material-icons">create_new_folder</span> Contenitore
                       </button>
                        <button id="ai-generator-btn" class="material-button material-button-filled flex items-center gap-2">
                           <span class="material-icons">auto_awesome</span> ✨ Genera con AI
                       </button>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row gap-2 mb-4">
                     <input type="text" id="search-sheets" placeholder="Cerca per nome scheda, esercizio, categoria..." class="input-field flex-grow">
                </div>
                <div id="sheets-list" class="space-y-4"></div>
            </div>

            <div id="page-history" class="hidden">
                <h2 class="text-2xl font-medium mb-4">Storico e Progressi</h2>
                
                <div class="flex border-b mb-4">
                    <button id="history-tab-dashboard" class="tab-button active">Dashboard</button>
                    <button id="history-tab-list" class="tab-button">Storico Dettagliato</button>
                </div>
                
                <div id="dashboard-container">
                    <!-- Contenuto Dashboard verrà inserito qui -->
                </div>

                <div id="history-list-container" class="hidden">
                    <div class="flex flex-col md:flex-row gap-2 mb-4">
                        <input type="text" id="search-history" placeholder="Cerca per nome esercizio o commento..." class="input-field flex-grow">
                        <input type="date" id="search-history-date" class="input-field">
                    </div>
                    <div id="history-list" class="space-y-6"></div>
                </div>
            </div>

            <div id="page-db" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-medium">Database Esercizi</h2>
                    <button id="add-category-btn" class="material-button material-button-outlined flex items-center gap-2">
                        <span class="material-icons">add</span> Categoria
                    </button>
                </div>
                 <div class="flex flex-col md:flex-row gap-2 mb-4">
                    <input type="text" id="search-exercises" placeholder="Cerca esercizio..." class="input-field flex-grow">
                    <select id="sort-exercises" class="input-field">
                        <option value="name_asc">Ordina per Nome (A-Z)</option>
                        <option value="name_desc">Ordina per Nome (Z-A)</option>
                        <option value="category">Ordina per Categoria</option>
                        <option value="bodypart">Ordina per Zona Corporea</option>
                        <option value="updatedAt_desc">Ordina per Ultima Modifica (più recente)</option>
                        <option value="createdAt_desc">Ordina per Data Creazione (più recente)</option>
                    </select>
                </div>
                <div id="categories-list" class="space-y-4"></div>
            </div>
        </main>
        
        <button id="workout-fab" title="Avvia Modalità Allenamento" class="fab fixed bottom-24 left-4 md:bottom-8 md:left-8 flex items-center justify-center z-30 transition-transform transform hover:scale-110 !bg-blue-200 !text-blue-800">
            <span class="material-icons">directions_run</span>
        </button>

        <button id="fab" class="fab fixed bottom-24 right-4 md:bottom-8 md:right-8 flex items-center justify-center z-30 transition-transform transform hover:scale-110">
            <span class="material-icons">add</span>
        </button>
        
    </div>

    <!-- ===== ELEMENTI SPOSTATI QUI (INIZIO) ===== -->
    <!-- Questi elementi sono stati spostati al di fuori di #app-container -->
    <!-- in modo che rimangano visibili anche quando #app-container è nascosto -->
    <div id="modal-container" class="fixed inset-0 z-[90] flex items-center justify-center modal-backdrop hidden"></div>
    <div id="confirm-modal" class="fixed inset-0 z-[95] flex items-center justify-center modal-backdrop hidden">
        <div class="modal-content p-6">
            <h3 id="confirm-title" class="text-xl font-medium mb-4">Conferma</h3>
            <p id="confirm-message" class="mb-6 text-gray-600">Sei sicuro di voler procedere?</p>
            <div id="confirm-buttons" class="flex justify-end gap-2">
                <button id="confirm-cancel" class="material-button material-button-text">Annulla</button>
                <button id="confirm-ok" class="material-button material-button-filled">Conferma</button>
            </div>
        </div>
    </div>
    <div id="toast-container" class="fixed bottom-24 md:bottom-8 right-1/2 translate-x-1/2 z-[100] space-y-2"></div>
    <!-- ===== ELEMENTI SPOSTATI QUI (FINE) ===== -->


    <script type="module">
        // Importa le funzioni di Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged,
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, onSnapshot, query, where, orderBy, serverTimestamp, writeBatch, Timestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configurazione di Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCZreK6wed9Y4HzddzXiFXsL8Cyl1921RQ",
            authDomain: "mariannagym-9672e.firebaseapp.com",
            databaseURL: "https://mariannagym-9672e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "mariannagym-9672e",
            storageBucket: "mariannagym-9672e.firebasestorage.app",
            messagingSenderId: "372540019319",
            appId: "1:372540019319:web:11904beb36482321116c72"
        };
        
        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Stato dell'applicazione
        const state = {
            userId: null,
            currentPage: 'sheets',
            categories: [],
            exercises: [],
            history: [],
            sheets: [],
            sheetContainers: [],
            sheetItems: {},
            workoutSessions: [], // Per la dashboard
            listeners: {},
            timers: {},
            isWorkoutModeActive: false,
            workout: null, // { sheetId, items, currentItemIndex, startTime, globalTimerIntervalId, elapsedSeconds }
        };
        
        const ZONES = ["Braccia", "Spalle", "Dorso", "Petto", "Addome", "Glutei", "Gambe", "Cardio"];
        const COLORS = [
            '#ef4444', '#f97316', '#f59e0b', '#84cc16', '#22c55e', 
            '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef'
        ];
        const CONTAINER_COLORS = [
            '#EFF6FF', '#F0FDF4', '#FEFCE8', '#FFF7ED', 
            '#FEF2F2', '#F5F3FF', '#FDF2F8', '#F3F4F6'
        ];

        // Elementi DOM
        const pages = {
            sheets: document.getElementById('page-sheets'),
            history: document.getElementById('page-history'),
            db: document.getElementById('page-db'),
        };
        const navs = {
            sheets: [document.getElementById('nav-sheets'), document.getElementById('nav-mobile-sheets')],
            history: [document.getElementById('nav-history'), document.getElementById('nav-mobile-history')],
            db: [document.getElementById('nav-db'), document.getElementById('nav-mobile-db')],
        };
        const fab = document.getElementById('fab');
        const modalContainer = document.getElementById('modal-container');
        
        // --- FUNZIONE UTILITY DI SANIFICAZIONE ---
        function sanitizeForId(text) {
            if (!text) return '';
            return text.replace(/[\s_]/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
        }

        // --- INIZIO FUNZIONALITÀ PRINCIPALI ---

        function navigate(page) {
            state.currentPage = page;
            Object.keys(pages).forEach(p => {
                pages[p].classList.toggle('hidden', p !== page);
                navs[p].forEach(nav => nav.classList.toggle('active', p === page));
            });
            updateFab();
            render();
        }

        function updateFab() {
            fab.onclick = null;
            let icon = 'add';
            switch (state.currentPage) {
                case 'sheets':
                    fab.title = 'Aggiungi Scheda';
                    fab.onclick = () => openSheetModal();
                    icon = 'assignment_add';
                    break;
                case 'history':
                    fab.title = 'Aggiungi Documentazione';
                    fab.onclick = () => openAddHistoryModal();
                    icon = 'post_add';
                    break;
                case 'db':
                    fab.title = 'Aggiungi Esercizio';
                    fab.onclick = () => openExerciseModal();
                    icon = 'fitness_center';
                    break;
            }
             fab.innerHTML = `<span class="material-icons">${icon}</span>`;
        }
        
        // --- FUNZIONI DI RENDERING ---
        function render() {
            if (!state.userId || state.isWorkoutModeActive) return; // Non renderizzare se in workout mode
            switch (state.currentPage) {
                case 'sheets': renderSheetsPage(); break;
                case 'history': renderHistoryPage(); break;
                case 'db': renderDbPage(); break;
            }
        }
        
        function renderDbPage() {
            const list = document.getElementById('categories-list');
            if (!list) return;

            const expansionState = getExpansionState();
            const searchTerm = document.getElementById('search-exercises').value.toLowerCase();
            const sortOption = document.getElementById('sort-exercises').value;

            let filteredExercises = state.exercises.filter(ex => 
                ex.name.toLowerCase().includes(searchTerm) ||
                (ex.zone && ex.zone.toLowerCase().includes(searchTerm)) ||
                state.categories.find(c => c.id === ex.categoryId)?.name.toLowerCase().includes(searchTerm)
            );

            // Sorting
            switch (sortOption) {
                case 'name_asc': filteredExercises.sort((a, b) => a.name.localeCompare(b.name)); break;
                case 'name_desc': filteredExercises.sort((a, b) => b.name.localeCompare(a.name)); break;
                case 'category':
                    filteredExercises.sort((a, b) => {
                        const catA = state.categories.find(c => c.id === a.categoryId)?.name || 'zzz';
                        const catB = state.categories.find(c => c.id === b.categoryId)?.name || 'zzz';
                        return catA.localeCompare(catB);
                    });
                    break;
                case 'bodypart': filteredExercises.sort((a, b) => (a.zone || '').localeCompare(b.zone || '')); break;
                case 'updatedAt_desc': filteredExercises.sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0)); break;
                case 'createdAt_desc': filteredExercises.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); break;
            }

            const exercisesByCategory = filteredExercises.reduce((acc, ex) => {
                const catId = ex.categoryId || 'uncategorized';
                if (!acc[catId]) acc[catId] = [];
                acc[catId].push(ex);
                return acc;
            }, {});

            if (state.categories.length === 0 && state.exercises.length === 0) {
                 list.innerHTML = `<div class="text-center p-8 bg-blue-50 text-blue-700 rounded-lg">
                    <h3 class="text-xl font-medium">Benvenuto!</h3>
                    <p class="mt-2">Inizia creando la tua prima categoria di esercizi usando il pulsante in alto a destra.</p>
                </div>`;
                return;
            }

            const allCategories = [...state.categories, {id: 'uncategorized', name: 'Non Categorizzati', description: 'Esercizi senza una categoria'}];

            list.innerHTML = allCategories.map(cat => {
                const exercises = exercisesByCategory[cat.id] || [];
                if (cat.id === 'uncategorized' && exercises.length === 0) return '';
                
                const isExpanded = expansionState.categories.includes(cat.id);
                return `
                    <div class="material-card">
                        <div class="p-4 cursor-pointer" onclick="window.app.toggleExpansion('category', '${cat.id}')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-medium text-[#49454f]">${cat.name}</h3>
                                    ${cat.description ? `<p class="text-sm text-gray-500">${cat.description}</p>` : ''}
                                </div>
                                <div class="flex items-center gap-2">
                                    ${cat.id !== 'uncategorized' ? `
                                        <button onclick="event.stopPropagation(); window.app.openCategoryModal('${cat.id}')" class="material-button-text p-2 rounded-full"><span class="material-icons text-lg">edit</span></button>
                                        <button onclick="event.stopPropagation(); window.app.deleteCategory('${cat.id}')" class="material-button-text p-2 rounded-full"><span class="material-icons text-lg">delete</span></button>
                                    ` : ''}
                                    <span id="icon-category-${cat.id}" class="material-icons transition-transform transform ${isExpanded ? 'rotate-180' : ''}">expand_more</span>
                                </div>
                            </div>
                        </div>
                        <div id="content-category-${cat.id}" style="display: ${isExpanded ? 'block' : 'none'}" class="border-t">
                            <div class="p-2 space-y-2">
                                ${exercises.length > 0 ? exercises.map(ex => `
                                    <div onclick="window.app.openExerciseModal('${ex.id}')" class="flex justify-between items-center p-2 rounded-lg hover:bg-gray-100 cursor-pointer">
                                        <div>
                                            <p class="font-medium">${ex.name}</p>
                                            ${ex.zone ? `<p class="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded-full inline-block">${ex.zone}</p>` : ''}
                                        </div>
                                        <span class="material-icons text-gray-400">chevron_right</span>
                                    </div>
                                `).join('') : '<p class="text-sm text-center text-gray-400 py-2">Nessun esercizio. Aggiungine uno con il pulsante flottante!</p>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderHistoryPage() {
            renderDashboard();
            renderHistoryList();
        }

        function renderHistoryList() {
             const list = document.getElementById('history-list');
             if (!list) return;

            const searchTerm = document.getElementById('search-history').value.toLowerCase();
            const searchDate = document.getElementById('search-history-date').value;
            
            let filteredHistory = state.history.filter(item => {
                const exercise = state.exercises.find(ex => ex.id === item.exerciseId);
                if (!exercise) return false;

                const nameMatch = exercise.name.toLowerCase().includes(searchTerm);
                const diary = item.diary || '';
                const diaryMatch = diary.toLowerCase().includes(searchTerm);

                let dateMatch = true;
                if (searchDate) {
                    const itemDate = new Date(item.timestamp.seconds * 1000).toISOString().split('T')[0];
                    dateMatch = itemDate === searchDate;
                }

                return (nameMatch || diaryMatch) && dateMatch;
            });
            
            const historyByDay = filteredHistory.reduce((acc, item) => {
                const date = new Date(item.timestamp.seconds * 1000).toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                if (!acc[date]) acc[date] = [];
                acc[date].push(item);
                return acc;
            }, {});

            const sortedDates = Object.keys(historyByDay).sort((a, b) => {
                const dateA = new Date(historyByDay[a][0].timestamp.seconds * 1000);
                const dateB = new Date(historyByDay[b][0].timestamp.seconds * 1000);
                return dateB - dateA;
            });

            if (sortedDates.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500">Nessun dato nello storico. Aggiungi una documentazione dal pulsante flottante!</p>`;
                return;
            }

            list.innerHTML = sortedDates.map(date => `
                <div>
                    <h3 class="text-lg font-medium text-gray-500 mb-2">${date}</h3>
                    <div class="space-y-2">
                        ${historyByDay[date].map(item => {
                            const exercise = state.exercises.find(ex => ex.id === item.exerciseId);
                            const category = state.categories.find(c => c.id === exercise?.categoryId);
                            
                            return `
                            <div class="material-card p-4">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-lg cursor-pointer hover:underline" onclick="window.app.openExerciseModal('${exercise?.id}')">${exercise?.name || 'Esercizio Eliminato'}</p>
                                        <p class="text-sm text-gray-500">${category?.name || 'N/A'}</p>
                                    </div>
                                    <div class="flex gap-1">
                                         <button onclick="window.app.openAddHistoryModal(null, '${item.id}')" class="material-button-text p-2 rounded-full"><span class="material-icons text-lg">edit</span></button>
                                         <button onclick="window.app.deleteHistoryItem('${item.id}')" class="material-button-text p-2 rounded-full"><span class="material-icons text-lg">delete</span></button>
                                    </div>
                                </div>
                                ${item.params && Object.keys(item.params).length > 0 ? `
                                <div class="mt-2 border-t pt-2">
                                    <h4 class="font-medium text-sm mb-1">Parametri Aggiornati:</h4>
                                    <ul class="list-disc list-inside text-sm space-y-1">
                                    ${Object.entries(item.params).map(([key, p]) => `
                                        <li>
                                            <strong>${key}:</strong> ${renderCompoundParam(p.value)}
                                            ${p.previousValue ? `
                                                <span class="text-xs text-gray-500 ml-2">
                                                    (prima: ${renderCompoundParam(p.previousValue)})
                                                    ${getComparisonArrow(p.value, p.previousValue)}
                                                </span>
                                            ` : '<span class="text-xs text-green-600 ml-2">(primo inserimento)</span>'}
                                        </li>
                                    `).join('')}
                                    </ul>
                                </div>` : ''}
                                ${item.diary ? `
                                <div class="mt-2 border-t pt-2">
                                     <h4 class="font-medium text-sm mb-1">Nota Diario:</h4>
                                     <p class="text-sm bg-yellow-50 p-2 rounded-md">${item.diary}</p>
                                </div>
                                ` : ''}
                            </div>`
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function renderDashboard() {
            const container = document.getElementById('dashboard-container');
            if (!container) return;

            const sessions = state.workoutSessions;
            if (sessions.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">Nessun allenamento completato in modalità allenamento. Avviane uno dal tasto blu in basso a sinistra!</p>`;
                return;
            }

            const totalWorkouts = sessions.length;
            const totalTimeSeconds = sessions.reduce((sum, s) => sum + s.durationSeconds, 0);
            const avgTimeSeconds = totalTimeSeconds > 0 ? totalTimeSeconds / totalWorkouts : 0;

            const sessionsBySheet = sessions.reduce((acc, session) => {
                if (!acc[session.sheetId]) {
                    acc[session.sheetId] = { name: session.sheetName, times: [] };
                }
                acc[session.sheetId].times.push({ id: session.id, date: session.startTime, duration: session.durationSeconds });
                return acc;
            }, {});

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="material-card p-4 text-center">
                        <h4 class="text-lg font-medium">Allenamenti Totali</h4>
                        <p class="text-3xl font-bold text-purple-600">${totalWorkouts}</p>
                    </div>
                    <div class="material-card p-4 text-center">
                        <h4 class="text-lg font-medium">Durata Media</h4>
                        <p class="text-3xl font-bold text-purple-600">${formatTime(Math.round(avgTimeSeconds))}</p>
                    </div>
                     <div class="material-card p-4 text-center">
                        <h4 class="text-lg font-medium">Tempo Totale</h4>
                        <p class="text-3xl font-bold text-purple-600">${formatTotalTime(totalTimeSeconds)}</p>
                    </div>
                </div>

                <h3 class="text-xl font-medium mb-2">Progresso per Scheda</h3>
                <div class="space-y-4">
                    ${Object.keys(sessionsBySheet).length > 0 ? Object.entries(sessionsBySheet).map(([sheetId, data]) => {
                        const sortedTimes = data.times.sort((a,b) => b.date.seconds - a.date.seconds);
                        const previewLimit = 3;
                        const hasMore = sortedTimes.length > previewLimit;

                        const renderSessionLi = (t) => `
                            <li class="flex justify-between items-center p-1 rounded hover:bg-gray-50">
                                <div>
                                    <span>${new Date(t.date.seconds * 1000).toLocaleDateString('it-IT', {day: '2-digit', month: 'long', year: 'numeric'})}</span>
                                    <span class="font-medium ml-4">${formatTime(t.duration)}</span>
                                </div>
                                <button onclick="window.app.deleteWorkoutSession('${t.id}')" title="Elimina sessione" class="material-button-text !p-1 !min-w-0 h-6 rounded-full text-gray-400 hover:text-red-600">
                                    <span class="material-icons text-base">delete_outline</span>
                                </button>
                            </li>
                        `;

                        return `
                        <div class="material-card p-4">
                            <h4 class="font-bold text-lg">${data.name}</h4>
                            <p class="text-sm text-gray-500 mb-2">Completata ${data.times.length} volte</p>
                            <ul class="space-y-1 text-sm">
                                ${sortedTimes.slice(0, previewLimit).map(renderSessionLi).join('')}
                                ${hasMore ? `
                                    <div id="extra-sessions-${sheetId}" class="hidden space-y-1">
                                        ${sortedTimes.slice(previewLimit).map(renderSessionLi).join('')}
                                    </div>
                                ` : ''}
                            </ul>
                            ${hasMore ? `
                                <button id="toggle-sessions-btn-${sheetId}" onclick="window.app.toggleExtraSessions('${sheetId}', ${sortedTimes.length - previewLimit})" class="material-button-text text-sm mt-2">
                                    Mostra Altri ${sortedTimes.length - previewLimit}
                                </button>
                            ` : ''}
                        </div>
                    `}).join('') : '<p class="text-gray-500">Nessuna scheda ripetuta.</p>'}
                </div>
            `;
        }


        function renderSheetsPage() {
            const list = document.getElementById('sheets-list');
            if (!list) return;

            const searchTerm = document.getElementById('search-sheets').value.toLowerCase();
            const expansionState = getExpansionState();

            const filteredSheets = state.sheets.filter(sheet => {
                if (searchTerm === '') return true;
                if (sheet.name.toLowerCase().includes(searchTerm) || (sheet.description && sheet.description.toLowerCase().includes(searchTerm))) {
                    return true;
                }
                const items = state.sheetItems[sheet.id] || [];
                return items.some(item => {
                    const exerciseIds = item.exerciseIds || (item.exerciseId ? [item.exerciseId] : []);
                    if (item.type !== 'exercise' || exerciseIds.length === 0) return false;
                    
                    return exerciseIds.some(exId => {
                        const exercise = state.exercises.find(ex => ex.id === exId);
                        if (!exercise) return false;
                        const category = state.categories.find(c => c.id === exercise.categoryId);
                        return exercise.name.toLowerCase().includes(searchTerm) || (category && category.name.toLowerCase().includes(searchTerm));
                    });
                });
            });

            const sheetsByContainer = filteredSheets.reduce((acc, sheet) => {
                const containerId = sheet.containerId || null; // Use null for consistency
                if (!acc[containerId]) acc[containerId] = [];
                acc[containerId].push(sheet);
                return acc;
            }, {});

            if (state.sheets.length === 0 && state.sheetContainers.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500">Nessuna scheda o contenitore. Inizia creando una scheda o usa il ✨ generatore AI.</p>`;
                return;
            }
            
            let html = state.sheetContainers.map((container, index, allContainers) => {
                const sheets = sheetsByContainer[container.id] || [];
                if (searchTerm !== '' && sheets.length === 0) return '';

                const isExpanded = expansionState.containers.includes(container.id);
                return `
                    <div class="material-card" style="background-color: ${container.color || '#EFF6FF'}">
                        <div class="p-4 cursor-pointer" onclick="window.app.toggleExpansion('container', '${container.id}')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="material-icons text-gray-700">folder</span>
                                        <h3 class="text-xl font-medium">${container.name}</h3>
                                    </div>
                                    ${container.description ? `<p class="text-sm text-gray-600 mt-1 ml-8">${container.description}</p>` : ''}
                                </div>
                                <div class="flex items-center">
                                    <button ${index === 0 ? 'disabled' : ''} onclick="event.stopPropagation(); window.app.reorderEntity('container', '${container.id}', 'up')" class="material-button-text p-2 rounded-full disabled:opacity-25"><span class="material-icons text-lg">arrow_upward</span></button>
                                    <button ${index === allContainers.length - 1 ? 'disabled' : ''} onclick="event.stopPropagation(); window.app.reorderEntity('container', '${container.id}', 'down')" class="material-button-text p-2 rounded-full disabled:opacity-25"><span class="material-icons text-lg">arrow_downward</span></button>
                                    <button onclick="event.stopPropagation(); window.app.openContainerModal('${container.id}')" class="material-button-text p-2 rounded-full"><span class="material-icons text-lg">edit</span></button>
                                    <button onclick="event.stopPropagation(); window.app.deleteContainer('${container.id}')" class="material-button-text p-2 rounded-full"><span class="material-icons text-lg">delete</span></button>
                                    <span id="icon-container-${container.id}" class="material-icons transition-transform transform ${isExpanded ? 'rotate-180' : ''}">expand_more</span>
                                </div>
                            </div>
                        </div>
                        <div id="content-container-${container.id}" style="display: ${isExpanded ? 'block' : 'none'}" class="border-t px-2 py-2 md:px-4 md:py-4 space-y-3">
                           ${sheets.length > 0 ? sheets.map((sheet, sheetIndex) => renderSingleSheet(sheet, expansionState.sheets.includes(sheet.id), sheetIndex, sheets.length)).join('') : '<p class="text-sm text-center text-gray-500 py-2">Nessuna scheda in questo contenitore.</p>'}
                        </div>
                    </div>
                `;
            }).join('');

            const unassignedSheets = sheetsByContainer[null] || [];
            if (unassignedSheets.length > 0) {
                 html += `
                    <div class="mt-6">
                        <h4 class="text-gray-500 font-medium mb-2 ml-1">Schede non assegnate</h4>
                        <div class="space-y-4">
                           ${unassignedSheets.map((sheet, sheetIndex) => renderSingleSheet(sheet, expansionState.sheets.includes(sheet.id), sheetIndex, unassignedSheets.length)).join('')}
                        </div>
                    </div>`;
            }
            
            list.innerHTML = html;
        }

        function renderSingleSheet(sheet, isExpanded, index, totalInList) {
             return `
                <div class="material-card !shadow-sm hover:!shadow-md">
                    <div class="p-4 cursor-pointer" onclick="window.app.toggleExpansion('sheet', '${sheet.id}')">
                         <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <div class="flex flex-col mr-2">
                                    <button ${index === 0 ? 'disabled' : ''} onclick="event.stopPropagation(); window.app.reorderEntity('sheet', '${sheet.id}', 'up')" class="material-button-text !p-1 !min-w-0 h-6 rounded-full disabled:opacity-25"><span class="material-icons text-lg">arrow_drop_up</span></button>
                                    <button ${index === totalInList - 1 ? 'disabled' : ''} onclick="event.stopPropagation(); window.app.reorderEntity('sheet', '${sheet.id}', 'down')" class="material-button-text !p-1 !min-w-0 h-6 rounded-full disabled:opacity-25"><span class="material-icons text-lg">arrow_drop_down</span></button>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium">${sheet.name}</h3>
                                    <p class="text-sm text-gray-500">${sheet.description || ''}</p>
                                </div>
                            </div>
                            <span id="icon-sheet-${sheet.id}" class="material-icons transition-transform transform ${isExpanded ? 'rotate-180' : ''}">expand_more</span>
                         </div>
                    </div>
                    <div id="content-sheet-${sheet.id}" style="display: ${isExpanded ? 'block' : 'none'}" class="border-t">
                        <div class="p-4 space-y-3">
                            <div class="flex justify-between items-center flex-wrap gap-2">
                                <p class="text-sm font-medium">Note: <span class="font-normal">${sheet.notes || 'Nessuna nota'}</span></p>
                                <div class="flex gap-2 flex-wrap">
                                    <button onclick="window.app.openSheetModal('${sheet.id}')" class="material-button-text p-2 rounded-full" title="Modifica Scheda"><span class="material-icons text-lg">edit</span></button>
                                    <button onclick="window.app.deleteSheet('${sheet.id}')" class="material-button-text p-2 rounded-full" title="Elimina Scheda"><span class="material-icons text-lg">delete</span></button>
                                    <button onclick="window.app.addItemsToSheet('${sheet.id}')" class="material-button-outlined text-sm px-3 py-1">Aggiungi Elementi</button>
                                    <button onclick="window.app.resetSheetDoneStatus('${sheet.id}')" class="material-button-text p-2 rounded-full" title="Segna tutti come 'da fare'"><span class="material-icons text-lg">refresh</span></button>
                                </div>
                            </div>
                            <div id="sheet-items-${sheet.id}" class="sheet-items-list">
                                ${renderSheetItems(sheet.id)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderSheetItems(sheetId) {
            const items = (state.sheetItems[sheetId] || []).sort((a,b) => a.order - b.order);
            if (items.length === 0) return `<p class="text-sm text-center text-gray-400 py-2">Questa scheda è vuota. Aggiungi esercizi o pause.</p>`;
            
            return items.map((item, index) => {
                switch (item.type) {
                    case 'exercise': return renderExerciseItem(item, sheetId, index, items.length);
                    case 'pause': return renderPauseItem(item, sheetId, index, items.length);
                    case 'text': return renderTextItem(item, sheetId, index, items.length);
                    default: return '';
                }
            }).join('');
        }

        function renderExerciseItem(item, sheetId, index, totalItems) {
            const exerciseIds = item.exerciseIds || (item.exerciseId ? [item.exerciseId] : []);
            if (exerciseIds.length === 0) return `<div class="p-2 border rounded bg-red-100 text-red-700">Esercizio non trovato (ID: ${item.exerciseId}) <button onclick="window.app.deleteSheetItem('${sheetId}', '${item.id}')" class="text-red-700 underline ml-2">Rimuovi</button></div>`;
            
            const isWorkout = state.isWorkoutModeActive;

            return `
                <div class="material-card p-3 flex flex-col sheet-item ${item.isDeactivated ? 'deactivated' : ''} ${item.isDone ? 'done' : ''}">
                     <div class="flex flex-col">
                        <div class="flex justify-between items-center h-8 mb-1">
                            ${!isWorkout ? `<div class="w-8"><input type="checkbox" ${item.isDone ? 'checked' : ''} onchange="window.app.toggleSheetItemDone('${sheetId}', '${item.id}', this.checked)" class="w-5 h-5 flex-shrink-0"></div>` : '<div></div>'}
                            ${!isWorkout ? `
                                <div class="flex items-center">
                                    ${renderReorderButtons(sheetId, item.id, index, totalItems)}
                                    <button onclick="window.app.openSheetItemActions('${sheetId}', '${item.id}')" class="material-button-text p-2 rounded-full"><span class="material-icons text-lg">more_vert</span></button>
                                </div>` 
                            : ''}
                        </div>
                        <div class="flex items-start gap-3">
                            ${isWorkout ? '<span class="material-icons text-purple-600 mt-1">fitness_center</span>' : ''}
                            <div class="w-full flex-grow">
                                ${renderVariantCarousel(sheetId, item.id, item, isWorkout)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderVariantCarousel(sheetId, itemId, item, isWorkout) {
            const exerciseIds = item.exerciseIds || (item.exerciseId ? [item.exerciseId] : []);
            const labels = item.labels || {};
            const carouselId = `carousel-${itemId}`;

            return `
            <div class="relative">
                <div class="variant-carousel-container" id="${carouselId}" data-current-index="0">
                    <div class="variant-carousel-track">
                        ${exerciseIds.map((exId, index) => {
                            const exercise = state.exercises.find(e => e.id === exId);
                            if (!exercise) return '';
                            const latestHistory = state.history
                                .filter(h => h.exerciseId === exId && h.params)
                                .sort((a,b) => b.timestamp.seconds - a.timestamp.seconds)[0];
                            const labelList = Array.isArray(labels[exId]) ? labels[exId] : [];
                            const labelHtml = labelList.map(label => 
                                `<span class="text-xs font-medium px-2 py-1 rounded-full mr-1" style="background-color:${label.color || '#cccccc'}; color: #fff;">${label.text}</span>`
                            ).join('');

                            return `
                                <div class="variant-slide p-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <span class="font-bold text-lg cursor-pointer hover:underline" onclick="window.app.openExerciseModal('${exercise.id}')">${exercise.name}</span>
                                            ${labelHtml ? `<div class="mt-1 flex flex-wrap gap-1">${labelHtml}</div>` : ''}
                                        </div>
                                        ${!isWorkout && exerciseIds.length > 1 && index > 0 ? `
                                            <button onclick="window.app.removeVariantFromSheetItem('${sheetId}', '${itemId}', '${exId}')" title="Rimuovi questa alternativa" class="material-button-text !p-1 !min-w-0 h-6 rounded-full text-gray-400 hover:text-red-600">
                                                <span class="material-icons text-base">remove_circle_outline</span>
                                            </button>
                                        ` : ''}
                                    </div>
                                    <div class="mt-2 space-y-2 w-full">
                                        <label class="font-medium text-sm">Ultima performance:</label>
                                        <div class="text-sm p-2 bg-gray-100 rounded space-y-1">
                                            ${(exercise.parameters && exercise.parameters.length > 0) ? exercise.parameters.map(paramName => {
                                                const lastValue = latestHistory?.params?.[paramName]?.value;
                                                return `<div><strong>${paramName}:</strong> ${renderCompoundParam(lastValue) || 'N/D'}</div>`;
                                            }).join('') : '<span>N/D</span>'}
                                        </div>
                                        <button onclick="window.app.openAddHistoryModal('${exercise.id}')" class="material-button-outlined text-xs px-3 py-1 mt-2">Aggiorna Parametri / Diario</button>
                                    </div>
                                </div>`;
                        }).join('')}
                    </div>
                </div>

                ${exerciseIds.length > 1 ? `
                    <button onclick="window.app.navigateCarousel('${carouselId}', -1)" class="variant-nav-button left-0 ml-[-16px] material-button-text !p-2 !min-w-0 h-8 w-8"><span class="material-icons text-xl">chevron_left</span></button>
                    <button onclick="window.app.navigateCarousel('${carouselId}', 1)" class="variant-nav-button right-0 mr-[-16px] material-button-text !p-2 !min-w-0 h-8 w-8"><span class="material-icons text-xl">chevron_right</span></button>
                ` : ''}
            </div>

            <div class="flex items-center justify-between mt-2 w-full">
                <div class="variant-dots flex-grow justify-center">
                    ${exerciseIds.map((_, index) => `<div class="variant-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></div>`).join('')}
                </div>
                <button onclick="window.app.openAddVariantModal('${sheetId}', '${itemId}', '${exerciseIds[0]}')" class="material-button-outlined text-xs px-2 py-1">+ Alternativa</button>
            </div>
            `;
        }

        function renderPauseItem(item, sheetId, index, totalItems) {
             const timerId = `timer-${item.id}`;
             const remaining = state.timers[timerId]?.remaining ?? item.duration;
             const isRunning = state.timers[timerId]?.intervalId;
             const isWorkout = state.isWorkoutModeActive;
            return `
                <div class="material-card p-3 flex items-center justify-between sheet-item ${item.isDeactivated ? 'deactivated' : ''}">
                     <div class="flex items-center gap-3">
                        <span class="material-icons text-blue-500">timer</span>
                        <div class="text-lg font-mono ${state.timers[timerId]?.isFinished ? 'blinking text-red-500' : ''}" id="${timerId}">${formatTime(remaining)}</div>
                    </div>
                    <div class="flex items-center">
                         <button onclick="window.app.toggleTimer('${item.id}', ${item.duration})" class="material-button-text p-2 rounded-full">
                            <span class="material-icons text-lg">${isRunning ? 'pause' : 'play_arrow'}</span>
                        </button>
                        <button onclick="window.app.resetTimer('${item.id}', ${item.duration})" class="material-button-text p-2 rounded-full"><span class="material-icons text-lg">replay</span></button>
                        ${!isWorkout ? `
                            ${renderReorderButtons(sheetId, item.id, index, totalItems)}
                            <button onclick="window.app.openSheetItemActions('${sheetId}', '${item.id}')" class="material-button-text p-2 rounded-full"><span class="material-icons text-lg">more_vert</span></button>
                        `: ''}
                    </div>
                </div>
            `;
        }

        function renderTextItem(item, sheetId, index, totalItems) {
            const isWorkout = state.isWorkoutModeActive;
            return `
                 <div class="material-card p-3 flex items-center justify-between sheet-item ${item.isDeactivated ? 'deactivated' : ''}">
                     <div class="flex items-center gap-3">
                        <span class="material-icons text-gray-500">notes</span>
                        <p>${item.text}</p>
                    </div>
                    ${!isWorkout ? `
                    <div class="flex items-center">
                         ${renderReorderButtons(sheetId, item.id, index, totalItems)}
                        <button onclick="window.app.openSheetItemActions('${sheetId}', '${item.id}')" class="material-button-text p-2 rounded-full"><span class="material-icons text-lg">more_vert</span></button>
                    </div>` : ''}
                </div>
            `;
        }

        function renderReorderButtons(sheetId, itemId, index, total) {
            return `
                <button ${index === 0 ? 'disabled' : ''} onclick="event.stopPropagation(); window.app.reorderSheetItem('${sheetId}', '${itemId}', 'up')" class="material-button-text p-2 rounded-full disabled:opacity-25"><span class="material-icons text-lg">arrow_upward</span></button>
                <button ${index === total - 1 ? 'disabled' : ''} onclick="event.stopPropagation(); window.app.reorderSheetItem('${sheetId}', '${itemId}', 'down')" class="material-button-text p-2 rounded-full disabled:opacity-25"><span class="material-icons text-lg">arrow_downward</span></button>
            `;
        }
        
        // --- FUNZIONI UTILITY ---
        function getComparisonArrow(newValueJSON, oldValueJSON) {
            if (!newValueJSON || !oldValueJSON) return '';
            try {
                const currentSets = JSON.parse(newValueJSON);
                const previousSets = JSON.parse(oldValueJSON);
                const currentVolume = (currentSets[0]?.val1 || 0) * (currentSets[0]?.val2 || 1);
                const previousVolume = (previousSets[0]?.val1 || 0) * (previousSets[0]?.val2 || 1);
                if (currentVolume > previousVolume) return '<span class="material-icons text-green-500 text-sm align-middle">arrow_upward</span>';
                if (currentVolume < previousVolume) return '<span class="material-icons text-red-500 text-sm align-middle">arrow_downward</span>';
            } catch (e) { /* ignore */ }
            return '';
        }
        
        function renderCompoundParam(jsonString) {
            if (!jsonString) return 'N/D';
            try {
                const sets = JSON.parse(jsonString);
                if (!Array.isArray(sets) || sets.length === 0) return 'N/D';
                return sets.map(set => 
                    Object.values(set).filter(v => v !== null && v !== '').join(' - ')
                ).join(' / ');
            } catch (e) {
                return 'Dati non validi';
            }
        }

        function showConfirm(title, message, onConfirm, onCancel = () => {}) {
             document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-message').innerHTML = message;
            const confirmModal = document.getElementById('confirm-modal');
            const buttonContainer = document.getElementById('confirm-buttons');
            
            buttonContainer.innerHTML = `
                <button id="confirm-cancel" class="material-button material-button-text">Annulla</button>
                <button id="confirm-ok" class="material-button material-button-filled">Conferma</button>
            `;

            const okButton = document.getElementById('confirm-ok');
            const cancelButton = document.getElementById('confirm-cancel');

            if (title.toLowerCase().includes('logout') || title.toLowerCase().includes('eliminazione') || title.toLowerCase().includes('termina')) {
                 okButton.classList.add('bg-red-600', 'hover:bg-red-700');
            }

            confirmModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');

            const close = () => {
                confirmModal.classList.add('hidden');
                if(!state.isWorkoutModeActive || modalContainer.classList.contains('hidden')) {
                     document.body.classList.remove('overflow-hidden');
                }
            }
            
            okButton.onclick = async () => {
                await onConfirm();
                close();
            };
            cancelButton.onclick = () => {
                onCancel();
                close();
            };
        }
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            toast.className = `toast ${bgColor} text-white text-sm font-medium px-4 py-2 rounded-full shadow-md opacity-0 transform translate-y-2`;
            toast.innerText = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
            }, 10);

            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
        }
        
        function formatGlobalTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function formatTotalTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            if (h > 0) return `${h}h ${m}m`;
            return `${m}m`;
        }
        
        const EXPANSION_STATE_KEY = 'workoutTrackerExpansionState';

        function getExpansionState() {
            try {
                const savedState = JSON.parse(localStorage.getItem(EXPANSION_STATE_KEY)) || {};
                return {
                    containers: savedState.containers || [],
                    sheets: savedState.sheets || [],
                    categories: savedState.categories || [],
                };
            } catch (e) {
                return { containers: [], sheets: [], categories: [] };
            }
        }

        function saveExpansionState(type, id, isExpanded) {
            const state = getExpansionState();
            let key;
            if (type === 'container') key = 'containers';
            else if (type === 'sheet') key = 'sheets';
            else if (type === 'category') key = 'categories';
            else return;
            
            const set = new Set(state[key]);
            if (isExpanded) {
                set.add(id);
            } else {
                set.delete(id);
            }
            state[key] = Array.from(set);
            
            localStorage.setItem(EXPANSION_STATE_KEY, JSON.stringify(state));
        }
        
        function toggleExpansion(type, id) {
            const content = document.getElementById(`content-${type}-${id}`);
            const icon = document.getElementById(`icon-${type}-${id}`);
            if (!content) return;
            
            const isExpanded = content.style.display !== 'none';

            content.style.display = isExpanded ? 'none' : 'block';
            icon?.classList.toggle('rotate-180', !isExpanded);
            saveExpansionState(type, id, !isExpanded);
        }


        // --- GESTIONE MODALS ---
        
        function closeModal() {
            modalContainer.classList.add('hidden');
            modalContainer.innerHTML = '';
            if(!state.isWorkoutModeActive) document.body.classList.remove('overflow-hidden');
        }

        function openCategoryModal(id = null) {
            const category = id ? state.categories.find(c => c.id === id) : null;
            const title = category ? 'Modifica Categoria' : 'Nuova Categoria';
            modalContainer.innerHTML = `
                <div class="modal-content p-6 overflow-y-auto">
                    <h3 class="text-xl font-medium mb-6">${title}</h3>
                    <div class="space-y-4">
                        <input type="text" id="category-name" placeholder="Nome Categoria" class="input-field" value="${category?.name || ''}">
                        <textarea id="category-description" placeholder="Descrizione (opzionale)" class="input-field min-h-[100px]">${category?.description || ''}</textarea>
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="window.app.closeModal()" class="material-button material-button-text">Annulla</button>
                        <button id="save-category-btn" class="material-button material-button-filled">Salva</button>
                    </div>
                </div>`;
            modalContainer.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            document.getElementById('save-category-btn').onclick = () => saveCategory(id);
        }
        
        function openExerciseModal(id = null) { 
            const exercise = id ? state.exercises.find(e => e.id === id) : null;
            const title = exercise ? 'Dettagli Esercizio' : 'Nuovo Esercizio';
            let subtitle = '';
            if (exercise) {
                const categoryName = state.categories.find(c=>c.id === exercise.categoryId)?.name;
                subtitle = [exercise.zone, categoryName].filter(Boolean).join(' - ');
            }
            
            modalContainer.innerHTML = `
                <div class="modal-content flex flex-col">
                    <div class="p-6 border-b">
                        <h3 class="text-xl font-medium">${title}</h3>
                        ${subtitle ? `<p class="text-sm text-gray-500">${subtitle}</p>`:''}
                    </div>
                    <div class="flex border-b">
                        <button id="tab-info" class="tab-button flex-1 active">Info</button>
                        <button id="tab-progress" class="tab-button flex-1 ${!id ? 'hidden' : ''}">Progressi</button>
                        <button id="tab-diary" class="tab-button flex-1 ${!id ? 'hidden' : ''}">Diario</button>
                        <button id="tab-ai" class="tab-button flex-1 ${!id ? 'hidden' : ''}">✨ Dettagli AI</button>
                    </div>
                    <div class="p-6 overflow-y-auto flex-1">
                        <div id="tab-content-info"></div>
                        <div id="tab-content-progress" class="hidden"></div>
                        <div id="tab-content-diary" class="hidden"></div>
                        <div id="tab-content-ai" class="hidden"></div>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-gray-50 border-t">
                        <div>
                            ${id ? `<button onclick="window.app.deleteExercise('${id}')" class="material-button material-button-text text-red-600">Elimina</button>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.app.closeModal()" class="material-button material-button-text">Chiudi</button>
                            <button id="save-exercise-btn" class="material-button material-button-filled">Salva</button>
                        </div>
                    </div>
                </div>
            `;
            
            const tabs = ['info', 'progress', 'diary', 'ai'];
            tabs.forEach(tab => {
                const tabButton = document.getElementById(`tab-${tab}`);
                if (tabButton) {
                    tabButton.onclick = () => {
                        tabs.forEach(t => {
                            document.getElementById(`tab-${t}`)?.classList.remove('active');
                            document.getElementById(`tab-content-${t}`)?.classList.add('hidden');
                        });
                        document.getElementById(`tab-${tab}`)?.classList.add('active');
                        document.getElementById(`tab-content-${tab}`)?.classList.remove('hidden');
                    };
                }
            });

            renderExerciseInfoTab(exercise);
            if (id) {
                renderExerciseProgressTab(exercise);
                renderExerciseDiaryTab(exercise);
                renderExerciseAiTab(exercise);
            }

            modalContainer.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            document.getElementById('save-exercise-btn').onclick = () => saveExercise(id);
        }

        function openSheetModal(id = null) {
             const sheet = id ? state.sheets.find(s => s.id === id) : null;
             const title = sheet ? 'Modifica Scheda' : 'Nuova Scheda';
             modalContainer.innerHTML = `
                <div class="modal-content p-6 overflow-y-auto">
                    <h3 class="text-xl font-medium mb-6">${title}</h3>
                    <div class="space-y-4">
                        <input type="text" id="sheet-name" placeholder="Nome Scheda" class="input-field" value="${sheet?.name || ''}">
                        <textarea id="sheet-description" placeholder="Descrizione (opzionale)" class="input-field">${sheet?.description || ''}</textarea>
                        
                        <div>
                            <label for="sheet-container" class="text-sm font-medium text-gray-700">Contenitore (opzionale)</label>
                            <select id="sheet-container" class="input-field mt-1">
                                <option value="">Nessun contenitore</option>
                                ${state.sheetContainers.map(c => `<option value="${c.id}" ${sheet?.containerId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                            </select>
                        </div>

                        <textarea id="sheet-notes" placeholder="Note (opzionale)" class="input-field min-h-[100px]">${sheet?.notes || ''}</textarea>
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="window.app.closeModal()" class="material-button material-button-text">Annulla</button>
                        <button id="save-sheet-btn" class="material-button material-button-filled">Salva</button>
                    </div>
                </div>`;
            modalContainer.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            document.getElementById('save-sheet-btn').onclick = () => saveSheet(id);
        }
        
        function openContainerModal(id = null) {
            const container = id ? state.sheetContainers.find(c => c.id === id) : null;
            const title = container ? 'Modifica Contenitore' : 'Nuovo Contenitore';
            modalContainer.innerHTML = `
                <div class="modal-content p-6 overflow-y-auto">
                    <h3 class="text-xl font-medium mb-6">${title}</h3>
                    <div class="space-y-4">
                        <input type="text" id="container-name" placeholder="Nome Contenitore" class="input-field" value="${container?.name || ''}">
                        <textarea id="container-description" placeholder="Descrizione (opzionale)" class="input-field min-h-[100px]">${container?.description || ''}</textarea>
                        <div>
                            <label class="text-sm font-medium text-gray-700">Colore Sfondo</label>
                            <input type="hidden" id="container-color" value="${container?.color || CONTAINER_COLORS[0]}">
                            <div class="flex flex-wrap gap-2 mt-2">
                                ${CONTAINER_COLORS.map(c => `<div onclick="document.getElementById('container-color').value='${c}'; document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('selected')); this.classList.add('selected');" class="color-dot w-8 h-8 ${(container?.color || CONTAINER_COLORS[0]) === c ? 'selected' : ''}" style="background-color:${c}"></div>`).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="window.app.closeModal()" class="material-button material-button-text">Annulla</button>
                        <button id="save-container-btn" class="material-button material-button-filled">Salva</button>
                    </div>
                </div>`;
            modalContainer.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            document.getElementById('save-container-btn').onclick = () => saveContainer(id);
        }

        function openAddHistoryModal(exerciseId = null, historyId = null) {
            const historyItem = historyId ? state.history.find(h => h.id === historyId) : null;
            const exerciseIdToUse = historyItem?.exerciseId || exerciseId;
            if (!exerciseIdToUse) {
                modalContainer.innerHTML = `
                    <div class="modal-content p-6 overflow-y-auto">
                        <h3 class="text-xl font-medium mb-4">Scegli un Esercizio</h3>
                        <select id="history-exercise-select" class="input-field">
                            <option value="">Seleziona...</option>
                            ${state.categories.map(cat => `
                                <optgroup label="${cat.name}">
                                    ${state.exercises.filter(ex => ex.categoryId === cat.id).map(ex => `
                                        <option value="${ex.id}">${ex.name}</option>
                                    `).join('')}
                                </optgroup>
                            `).join('')}
                        </select>
                        <div class="flex justify-end gap-2 mt-6">
                            <button onclick="window.app.closeModal()" class="material-button material-button-text">Annulla</button>
                            <button onclick="const val = document.getElementById('history-exercise-select').value; if(val) window.app.openAddHistoryModal(val);" class="material-button material-button-filled">Avanti</button>
                        </div>
                    </div>`;
                modalContainer.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                return;
            }

            const exercise = state.exercises.find(e => e.id === exerciseIdToUse);
            if (!exercise) return showToast("Esercizio non trovato.", 'error');
            
            const latestHistoryItem = historyId ? null : state.history
                .filter(h => h.exerciseId === exerciseIdToUse && h.params)
                .sort((a, b) => b.timestamp.seconds - a.timestamp.seconds)[0];

            const title = historyId ? 'Modifica Documentazione' : 'Aggiungi Documentazione';
            
            modalContainer.innerHTML = `
                 <div class="modal-content p-6 overflow-y-auto">
                    <h3 class="text-xl font-medium mb-2">${title}</h3>
                    <p class="mb-4 text-gray-600">per <strong>${exercise.name}</strong></p>
                    
                    <div class="space-y-4">
                        <input type="datetime-local" id="history-timestamp" class="input-field" value="${historyItem ? new Date(historyItem.timestamp.seconds * 1000 - new Date().getTimezoneOffset() * 60000).toISOString().substring(0, 16) : new Date(Date.now() - new Date().getTimezoneOffset() * 60000).toISOString().substring(0, 16)}">
                        
                        <div id="params-container" class="space-y-4">
                             ${(exercise.parameters && exercise.parameters.length > 0) ? exercise.parameters.map(paramName => {
                                 let sets = [];
                                 const valuesToLoad = historyItem?.params?.[paramName]?.value || latestHistoryItem?.params?.[paramName]?.value;
                                 try { 
                                     sets = JSON.parse(valuesToLoad || '[{}]'); 
                                 } catch(e){ 
                                     sets = [{}]; 
                                 }
                                 if (!Array.isArray(sets) || sets.length === 0) { sets = [{}]; }
                                 
                                 const paramId = sanitizeForId(paramName);
                                 return `
                                    <div class="p-2 border rounded" data-param-name="${paramName}">
                                        <label class="font-medium">${paramName}</label>
                                        <div class="space-y-2 mt-1" id="sets-for-${paramId}">
                                            ${sets.map((set, index) => {
                                                const fields = Object.values(set).filter(v => v !== null && v !== '');
                                                let setHtml = `<div class="flex gap-1.5 items-center" data-set-index="${index}">`;

                                                if (fields.length === 0) {
                                                    setHtml += `<input type="text" placeholder="" class="input-field !p-2 flex-1" value="">`;
                                                } else {
                                                    setHtml += Object.entries(set)
                                                        .filter(([k, v]) => v !== null)
                                                        .map(([key, value]) => `<input type="text" placeholder="" class="input-field !p-2 flex-1" value="${value || ''}">`).join('');
                                                }

                                                setHtml += `<button onclick="window.app.addInputFieldToSet(this)" class="material-button-text p-2 rounded-full !min-w-0"><span class="material-icons">add</span></button>
                                                            <button onclick="this.parentElement.remove()" class="material-button-text p-2 rounded-full !min-w-0"><span class="material-icons">remove_circle_outline</span></button>
                                                          </div>`;
                                                return setHtml;
                                            }).join('')}
                                        </div>
                                        <button onclick="window.app.addParamSet('${paramId}')" class="material-button-outlined text-xs px-3 py-1 mt-2">Aggiungi Riga</button>
                                    </div>`;
                                }).join('') : '<p class="text-gray-500 text-sm">Nessun parametro da tracciare per questo esercizio. Modifica l\'esercizio per aggiungerne.</p>'}
                        </div>

                        <textarea id="history-diary" placeholder="Nota nel diario (opzionale)" class="input-field min-h-[100px]">${historyItem?.diary || ''}</textarea>
                    </div>

                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="window.app.closeModal()" class="material-button material-button-text">Annulla</button>
                        <button id="save-history-btn" class="material-button material-button-filled">Salva</button>
                    </div>
                </div>
            `;
            modalContainer.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            document.getElementById('save-history-btn').onclick = () => saveHistoryItem(exercise.id, historyId);
        }

        function addItemsToSheet(sheetId) {
            let selectionOrder = [];

            function renderExerciseSelection() {
                const listContainer = document.getElementById('exercise-selection-list');
                if (!listContainer) return;
                
                const searchTerm = document.getElementById('search-exercises-in-modal')?.value.toLowerCase() || '';

                let filteredExercises = state.exercises.filter(ex => {
                    if (!searchTerm) return true;
                    const category = state.categories.find(c => c.id === ex.categoryId);
                    return ex.name.toLowerCase().includes(searchTerm) ||
                           (ex.zone && ex.zone.toLowerCase().includes(searchTerm)) ||
                           (category && category.name.toLowerCase().includes(searchTerm));
                });
                
                const exercisesByCategory = filteredExercises.reduce((acc, ex) => {
                    const catId = ex.categoryId || 'uncategorized';
                    if (!acc[catId]) acc[catId] = [];
                    acc[catId].push(ex);
                    return acc;
                }, {});

                const allCategories = [...state.categories, {id: 'uncategorized', name: 'Non Categorizzati'}];
                
                let html = allCategories.map(cat => {
                    const exercises = exercisesByCategory[cat.id] || [];
                    if (exercises.length === 0) return ''; 

                    return `
                        <div>
                            <h4 class="font-bold text-gray-600 mt-2 first:mt-0">${cat.name}</h4>
                            ${exercises.map(ex => {
                                const selectionIndex = selectionOrder.indexOf(ex.id);
                                const isSelected = selectionIndex !== -1;
                                return `
                                    <div data-exercise-id="${ex.id}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-100 cursor-pointer">
                                        <div class="w-6 h-6 flex items-center justify-center rounded-full text-sm font-bold border-2 ${isSelected ? 'bg-purple-600 border-purple-600 text-white' : 'border-gray-300'}">
                                            ${isSelected ? (selectionIndex + 1) : ''}
                                        </div>
                                        <span>${ex.name}</span>
                                    </div>`;
                            }).join('')}
                        </div>`;
                }).join('');

                if (filteredExercises.length === 0) {
                    html = '<p class="text-center text-gray-500 p-4">Nessun esercizio trovato.</p>';
                }

                listContainer.innerHTML = html;
            }
            
            modalContainer.innerHTML = `
                <div class="modal-content p-6 overflow-y-auto">
                    <h3 class="text-xl font-medium mb-4">Aggiungi Elementi alla Scheda</h3>
                    <div class="flex gap-2 mb-4">
                        <button id="add-item-type-exercise" class="tab-button active">Esercizi</button>
                        <button id="add-item-type-pause" class="tab-button">Pausa</button>
                        <button id="add-item-type-text" class="tab-button">Testo</button>
                    </div>
                    <div id="add-items-content"></div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="window.app.closeModal()" class="material-button material-button-text">Annulla</button>
                        <button id="save-items-btn" class="material-button material-button-filled">Aggiungi Selezionati</button>
                    </div>
                </div>`;

            const renderContent = (type) => {
                const contentDiv = document.getElementById('add-items-content');
                document.querySelectorAll('.modal-content .tab-button').forEach(b => b.classList.remove('active'));
                document.getElementById(`add-item-type-${type}`).classList.add('active');
                
                switch(type) {
                    case 'exercise':
                        contentDiv.innerHTML = `
                            <input type="text" id="search-exercises-in-modal" placeholder="Cerca per nome, zona o categoria..." class="input-field mb-2">
                            <div id="exercise-selection-list" class="max-h-60 overflow-y-auto space-y-2 border p-2 rounded"></div>
                        `;
                        document.getElementById('search-exercises-in-modal').addEventListener('input', renderExerciseSelection);
                        
                        renderExerciseSelection(); 
                        
                        const listContainer = document.getElementById('exercise-selection-list');
                        if (listContainer) {
                            listContainer.addEventListener('click', (event) => {
                                const exerciseRow = event.target.closest('[data-exercise-id]');
                                if (!exerciseRow) return;

                                const exerciseId = exerciseRow.dataset.exerciseId;
                                const index = selectionOrder.indexOf(exerciseId);
                                if (index > -1) {
                                    selectionOrder.splice(index, 1);
                                } else {
                                    selectionOrder.push(exerciseId);
                                }
                                renderExerciseSelection();
                            });
                        }
                        break;
                    case 'pause':
                        contentDiv.innerHTML = `
                        <div class="flex gap-2 items-center">
                            <input type="number" id="pause-minutes" placeholder="Minuti" class="input-field !p-2 w-1/2">
                            <input type="number" id="pause-seconds" placeholder="Secondi" class="input-field !p-2 w-1/2">
                        </div>`;
                        break;
                    case 'text':
                        contentDiv.innerHTML = `<textarea id="text-content" placeholder="Scrivi una nota per la scheda..." class="input-field min-h-[100px]"></textarea>`;
                        break;
                }
            }
            
            document.getElementById('add-item-type-exercise').onclick = () => renderContent('exercise');
            document.getElementById('add-item-type-pause').onclick = () => renderContent('pause');
            document.getElementById('add-item-type-text').onclick = () => renderContent('text');
            
            document.getElementById('save-items-btn').onclick = () => {
                const activeTab = document.querySelector('.modal-content .tab-button.active')?.id;
                let itemsToAdd = [];
                if (activeTab === 'add-item-type-exercise') {
                    selectionOrder.forEach(exerciseId => {
                        itemsToAdd.push({ type: 'exercise', exerciseIds: [exerciseId] });
                    });
                } else if (activeTab === 'add-item-type-pause') {
                     const minutes = parseInt(document.getElementById('pause-minutes').value) || 0;
                     const seconds = parseInt(document.getElementById('pause-seconds').value) || 0;
                     const totalSeconds = minutes * 60 + seconds;
                     if (totalSeconds > 0) itemsToAdd.push({ type: 'pause', duration: totalSeconds });
                } else if (activeTab === 'add-item-type-text') {
                    const text = document.getElementById('text-content').value.trim();
                    if (text) itemsToAdd.push({ type: 'text', text: text });
                }
                saveItemsToSheet(sheetId, itemsToAdd);
            };
            
            renderContent('exercise');
            modalContainer.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }
        
        // --- RENDER TAB DEI MODAL ---
        
        function renderExerciseInfoTab(exercise) {
            const container = document.getElementById('tab-content-info');
            container.innerHTML = `
                <div class="space-y-4">
                    <input type="text" id="exercise-name" placeholder="Nome Esercizio" class="input-field" value="${exercise?.name || ''}">
                    <select id="exercise-zone" class="input-field">
                        <option value="">Seleziona Zona Allenamento (Opzionale)</option>
                        ${ZONES.map(z => `<option value="${z}" ${exercise?.zone === z ? 'selected' : ''}>${z}</option>`).join('')}
                    </select>
                    <select id="exercise-category" class="input-field">
                        <option value="">Nessuna Categoria</option>
                         ${state.categories.map(c => `<option value="${c.id}" ${exercise?.categoryId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                    </select>

                    <div>
                        <h4 class="font-medium mb-2">Parametri da tracciare</h4>
                        <div id="parameters-list" class="space-y-2">
                            ${(exercise?.parameters || []).map(p => `
                                <div class="flex items-center gap-2">
                                    <input type="text" class="input-field !p-2 flex-grow" value="${p}">
                                    <button onclick="this.parentElement.remove()" class="material-button-text p-2 rounded-full"><span class="material-icons">remove_circle_outline</span></button>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="window.app.addParameterField()" class="material-button-outlined text-sm px-3 py-1 mt-2">Aggiungi Parametro</button>
                    </div>
                </div>
            `;
        }
        
        function renderExerciseProgressTab(exercise) {
            const container = document.getElementById('tab-content-progress');
            const exerciseHistory = state.history.filter(h => h.exerciseId === exercise.id && h.params && Object.keys(h.params).length > 0)
                                        .sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);
            
            if (exerciseHistory.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">Nessun progresso registrato per questo esercizio.</p>`;
                return;
            }

            container.innerHTML = `
                <div class="space-y-2 max-h-80 overflow-y-auto">
                    ${exerciseHistory.map(h => `
                        <div class="text-sm p-2 bg-gray-50 rounded">
                            <p class="font-bold">${new Date(h.timestamp.seconds * 1000).toLocaleString('it-IT')}</p>
                            ${Object.entries(h.params).map(([key, p]) => `<p><strong>${key}:</strong> ${renderCompoundParam(p.value)}</p>`).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderExerciseDiaryTab(exercise) {
             const container = document.getElementById('tab-content-diary');
             const diaryEntries = state.history.filter(h => h.exerciseId === exercise.id && h.diary)
                                            .sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);
            
            if (diaryEntries.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">Nessuna nota nel diario per questo esercizio.</p>`;
                return;
            }

            container.innerHTML = `
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    ${diaryEntries.map(d => `
                        <div class="p-3 bg-yellow-50 rounded-lg">
                            <div class="flex justify-between items-center text-sm mb-1">
                                <p class="font-bold">${new Date(d.timestamp.seconds * 1000).toLocaleString('it-IT')}</p>
                                <div class="flex">
                                    <button onclick="window.app.openAddHistoryModal(null, '${d.id}')" class="material-button-text p-1 rounded-full"><span class="material-icons text-base">edit</span></button>
                                    <button onclick="window.app.deleteHistoryItem('${d.id}')" class="material-button-text p-1 rounded-full"><span class="material-icons text-base">delete</span></button>
                                </div>
                            </div>
                            <p>${d.diary}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // --- FUNZIONI GEMINI API ---
        
        function renderExerciseAiTab(exercise) {
            const container = document.getElementById('tab-content-ai');
            if (exercise.aiDetails) {
                 container.innerHTML = `
                    <div id="ai-info-content" class="prose max-w-none">${exercise.aiDetails}</div>
                    <div class="text-center mt-4">
                        <button id="get-ai-info-btn" class="material-button material-button-outlined">✨ Rigenera con AI</button>
                    </div>
                `;
            } else {
                 container.innerHTML = `
                    <div class="text-center">
                        <button id="get-ai-info-btn" class="material-button material-button-filled">✨ Chiedi all'AI</button>
                    </div>
                    <div id="ai-info-content" class="mt-4 prose max-w-none"></div>
                `;
            }
            document.getElementById('get-ai-info-btn').onclick = () => getAiExerciseInfo(exercise);
        }

        async function callGeminiAPI(prompt, isJson = false) {
            const apiKey = "AIzaSyDQsDl_3T9b9ludO4DCiRvifzPYvNVM9t8"; 

            if (apiKey === "INSERISCI_QUI_LA_TUA_CHIAVE_API") {
                 showToast("Chiave API di Gemini non configurata.", "error");
                 console.error("ERRORE: La chiave API di Gemini non è stata impostata. Inseriscila nella funzione 'callGeminiAPI'.");
                 return null;
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (isJson) {
                payload.generationConfig = { responseMimeType: "application/json" };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Error Response:", errorBody);
                    throw new Error(`Errore API: ${response.statusText}`);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("Risposta API non valida o vuota.");
                return text;
            } catch (error) {
                console.error("Errore chiamata Gemini API:", error);
                showToast("Errore durante la comunicazione con l'AI.", "error");
                return null;
            }
        }
        
        async function getAiExerciseInfo(exercise) {
            const button = document.getElementById('get-ai-info-btn');
            const contentDiv = document.getElementById('ai-info-content');
            if (!button || !contentDiv) return;

            button.disabled = true;
            contentDiv.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>';

            const prompt = `Sei un esperto personal trainer. Fornisci una spiegazione dettagliata per l'esercizio "${exercise.name}". La tua risposta deve essere in italiano e ben formattata. Includi le seguenti sezioni: 
                1. **Esecuzione Corretta:** Spiega passo dopo passo come eseguire l'esercizio.
                2. **Muscoli Coinvolti:** Elenca i muscoli primari e secondari allenati.
                3. **Errori Comuni:** Descrivi 2-3 errori comuni da evitare.
                4. **Varianti e Alternative:** Suggerisci 2-3 varianti dell'esercizio o alternative che colpiscono muscoli simili.
                Formatta la risposta usando HTML con paragrafi, liste puntate e grassetto per i titoli. Non includere \`\`\`html o markdown.`;

            const responseText = await callGeminiAPI(prompt);
            
            button.disabled = false;
            if (responseText) {
                 contentDiv.innerHTML = responseText;
                 button.textContent = '✨ Rigenera con AI';
                 button.className = 'material-button material-button-outlined';
                 saveAiDetailsToExercise(exercise.id, responseText);
            } else {
                 contentDiv.innerHTML = '<p class="text-center text-red-500">Impossibile ottenere le informazioni.</p>';
            }
        }

        function openAiGeneratorModal() {
             modalContainer.innerHTML = `
                <div class="modal-content p-6 overflow-y-auto">
                    <h3 class="text-xl font-medium mb-1">✨ Generatore di Schede AI</h3>
                    <p class="text-sm text-gray-500 mb-6">Descrivi il tuo obiettivo e l'AI creerà un piano per te.</p>
                    <div id="ai-generator-form" class="space-y-4">
                        <input type="text" id="ai-sheet-name" placeholder="Nome del nuovo piano (es. 'Massa Muscolare 3 giorni')" class="input-field">
                        <div>
                            <label for="ai-goal" class="text-sm font-medium text-gray-700">Qual è il tuo obiettivo principale?</label>
                            <select id="ai-goal" class="input-field mt-1">
                                <option value="ipertrofia">Ipertrofia (Aumento massa muscolare)</option>
                                <option value="forza">Forza Massimale</option>
                                <option value="resistenza">Resistenza Muscolare</option>
                                <option value="dimagrimento">Dimagrimento e Condizionamento</option>
                            </select>
                        </div>
                        <div>
                           <label for="ai-days" class="text-sm font-medium text-gray-700">Quanti giorni a settimana ti alleni?</label>
                           <input type="number" id="ai-days" placeholder="Es. 3" class="input-field mt-1" min="1" max="7">
                        </div>
                        <div>
                           <label for="ai-equipment" class="text-sm font-medium text-gray-700">Quale attrezzatura hai a disposizione?</label>
                           <textarea id="ai-equipment" placeholder="Es. manubri, bilanciere, panca, sbarra per trazioni, elastici..." class="input-field min-h-[100px] mt-1"></textarea>
                        </div>
                    </div>
                     <div id="ai-generator-loader" class="hidden text-center py-8">
                        <div class="flex justify-center mb-4"><div class="loader"></div></div>
                        <p>L'AI sta creando il tuo piano personalizzato...</p>
                        <p class="text-sm text-gray-500">Potrebbe richiedere fino a 30 secondi.</p>
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="window.app.closeModal()" class="material-button material-button-text">Annulla</button>
                        <button id="generate-ai-sheet-btn" class="material-button material-button-filled">✨ Genera Piano</button>
                    </div>
                </div>`;
            modalContainer.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            document.getElementById('generate-ai-sheet-btn').onclick = generateAiSheet;
        }

        async function generateAiSheet() {
            const name = document.getElementById('ai-sheet-name').value.trim();
            const goal = document.getElementById('ai-goal').value;
            const days = document.getElementById('ai-days').value;
            const equipment = document.getElementById('ai-equipment').value.trim();

            if (!name || !goal || !days || !equipment) {
                return showToast("Per favore, compila tutti i campi.", "error");
            }

            document.getElementById('ai-generator-form').classList.add('hidden');
            document.getElementById('generate-ai-sheet-btn').classList.add('hidden');
            document.getElementById('ai-generator-loader').classList.remove('hidden');

            const availableExercises = state.exercises.map(ex => `"${ex.name}"`).join(', ');

            const prompt = `Sei un esperto personal trainer. Crea un piano di allenamento dettagliato basato sulle seguenti informazioni:
            - Obiettivo: ${goal}
            - Giorni di allenamento a settimana: ${days}
            - Attrezzatura disponibile: ${equipment}
            - Esercizi disponibili nel database dell'utente: [${availableExercises}]

            ISTRUZIONI IMPORTANTI:
            1. Usa SOLO ed ESCLUSIVAMENTE gli esercizi dalla lista fornita. Non inventare esercizi. Se la lista è vuota, rispondi con un errore.
            2. Se mancano esercizi fondamentali per l'obiettivo, aggiungi un commento nella sezione "notes".
            3. Crea ${days} schede distinte, una per ogni giorno di allenamento.
            4. Per ogni esercizio, suggerisci un numero di serie e ripetizioni (es. 3x10, 4x8, 5x5) e inseriscilo nel campo "text" di un elemento di tipo "text" subito dopo l'esercizio.
            5. Inserisci una pausa (elemento "pause") dopo ogni esercizio. La durata dovrebbe essere tra 60 e 120 secondi.
            
            Restituisci la risposta ESCLUSIVAMENTE in formato JSON. Il JSON deve avere la seguente struttura:
            {
              "description": "Una breve descrizione generale del piano di allenamento.",
              "notes": "Note generali o consigli per l'utente, come ad esempio suggerimenti su esercizi mancanti.",
              "days": [
                {
                  "dayName": "Giorno A: Nome della sessione (es. Spinta)",
                  "items": [
                    { "type": "exercise", "exerciseName": "Nome Esatto Esercizio Dal Database" },
                    { "type": "text", "text": "3x10" },
                    { "type": "pause", "duration": 90 },
                    { "type": "exercise", "exerciseName": "Altro Esercizio" },
                    { "type": "text", "text": "4x8" },
                    { "type": "pause", "duration": 120 }
                  ]
                }
              ]
            }`;

            const responseJsonString = await callGeminiAPI(prompt, true);
            if (!responseJsonString) {
                 document.getElementById('ai-generator-form').classList.remove('hidden');
                 document.getElementById('generate-ai-sheet-btn').classList.remove('hidden');
                 document.getElementById('ai-generator-loader').classList.add('hidden');
                 return;
            }

            try {
                const plan = JSON.parse(responseJsonString);
                const { userId } = state;
                const batch = writeBatch(db);

                let maxOrder = state.sheets.reduce((max, s) => Math.max(s.order || 0), -1);

                for (const day of plan.days) {
                    maxOrder++;
                    const sheetData = {
                        name: `${name} - ${day.dayName}`,
                        description: plan.description || '',
                        notes: plan.notes || '',
                        containerId: null,
                        order: maxOrder,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    const sheetRef = doc(collection(db, `/users/${userId}/workoutSheets`));
                    batch.set(sheetRef, sheetData);

                    let itemOrder = 0;
                    for (const item of day.items) {
                        const exercise = state.exercises.find(ex => ex.name.toLowerCase() === item.exerciseName?.toLowerCase());
                        if (item.type === 'exercise' && !exercise) {
                            console.warn(`AI ha suggerito l'esercizio "${item.exerciseName}" non trovato nel database. Saltato.`);
                            continue;
                        }

                        const itemData = {
                            order: itemOrder++,
                            isDone: false,
                            isDeactivated: false,
                            createdAt: serverTimestamp()
                        };
                        
                        if (item.type === 'exercise') {
                            itemData.type = 'exercise';
                            itemData.exerciseIds = [exercise.id]; // Inizializza con l'array
                        } else {
                            Object.assign(itemData, item);
                        }
                        
                        const itemRef = doc(collection(db, sheetRef.path, 'items'));
                        batch.set(itemRef, itemData);
                    }
                }
                
                await batch.commit();
                closeModal();
                showToast("Piano di allenamento generato con successo!", "success");

            } catch(e) {
                console.error("Errore durante il parsing o salvataggio del piano AI:", e);
                showToast("L'AI ha restituito un formato non valido. Riprova.", "error");
                document.getElementById('ai-generator-form').classList.remove('hidden');
                document.getElementById('generate-ai-sheet-btn').classList.remove('hidden');
                document.getElementById('ai-generator-loader').classList.add('hidden');
            }
        }
        
        // --- LOGICA DATABASE (Firestore) ---
        
        async function saveAiDetailsToExercise(exerciseId, details) {
            const { userId } = state;
            if (!userId || !exerciseId) return;
            try {
                const docRef = doc(db, `/users/${userId}/exercises`, exerciseId);
                await updateDoc(docRef, { aiDetails: details });
            } catch (e) {
                console.error("Errore durante il salvataggio dei dettagli AI:", e);
            }
        }
        
        async function saveCategory(id = null) {
            const { userId } = state;
            if (!userId) return showToast("Utente non autenticato.", 'error');
            const name = document.getElementById('category-name').value.trim();
            const description = document.getElementById('category-description').value.trim();
            if (!name) return showToast("Il nome della categoria è obbligatorio.", 'error');

            try {
                const data = { name, description, updatedAt: serverTimestamp() };
                const collectionPath = `/users/${userId}/categories`;
                if (id) {
                    await setDoc(doc(db, collectionPath, id), data, { merge: true });
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, collectionPath), data);
                }
                closeModal();
                showToast(`Categoria "${name}" salvata con successo.`, 'success');
            } catch (e) {
                console.error("Errore salvataggio categoria:", e);
                showToast("Si è verificato un errore.", 'error');
            }
        }

        function deleteCategory(id) {
            const { userId } = state;
            if (!userId) return showToast("Utente non autenticato.", 'error');
            const category = state.categories.find(c => c.id === id);
            if (!category) return;
            const exercisesInCategory = state.exercises.filter(ex => ex.categoryId === id);
            let message = `Sei sicuro di voler eliminare la categoria "<strong>${category.name}</strong>"?`;
            if (exercisesInCategory.length > 0) {
                message += `<br>Ci sono <strong>${exercisesInCategory.length}</strong> esercizi in questa categoria. Saranno spostati in "Non Categorizzati".`;
            }
            showConfirm('Conferma Eliminazione', message, async () => {
                try {
                    const batch = writeBatch(db);
                    exercisesInCategory.forEach(ex => {
                        const exRef = doc(db, `/users/${userId}/exercises`, ex.id);
                        batch.update(exRef, { categoryId: null });
                    });
                    const catRef = doc(db, `/users/${userId}/categories`, id);
                    batch.delete(catRef);
                    await batch.commit();
                    showToast(`Categoria "${category.name}" eliminata.`, 'success');
                } catch (e) {
                    console.error("Errore eliminazione categoria:", e);
                    showToast("Errore durante l'eliminazione.", 'error');
                }
            });
        }
        
        async function saveExercise(id = null) {
            const { userId } = state;
            if (!userId) return showToast("Utente non autenticato.", 'error');
            const name = document.getElementById('exercise-name').value.trim();
            const zone = document.getElementById('exercise-zone').value || null;
            const categoryId = document.getElementById('exercise-category').value || null;
            
            if (!name) return showToast("Il nome dell'esercizio è obbligatorio.", 'error');

            const parameters = Array.from(document.querySelectorAll('#parameters-list > div'))
                .map(div => div.querySelector('input').value.trim())
                .filter(Boolean);
            
            const existingExercise = id ? state.exercises.find(e => e.id === id) : {};
            const data = { 
                name, 
                zone, 
                categoryId, 
                parameters, 
                updatedAt: serverTimestamp(),
                aiDetails: existingExercise.aiDetails || null 
            };
            
            const collectionPath = `/users/${userId}/exercises`;

            try {
                if (id) {
                    await setDoc(doc(db, collectionPath, id), data, { merge: true });
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, collectionPath), data);
                }
                closeModal();
                showToast(`Esercizio "${name}" salvato.`, 'success');
            } catch(e) {
                console.error("Errore salvataggio esercizio:", e);
                showToast("Errore durante il salvataggio.", 'error');
            }
        }

        async function deleteExercise(id) {
            const { userId } = state;
            if (!userId) return showToast("Utente non autenticato.", 'error');
            showConfirm("Conferma Eliminazione", "Sei sicuro di voler eliminare questo esercizio? Verranno eliminati anche tutti i dati storici e le occorrenze nelle schede. L'azione è irreversibile.", async () => {
                try {
                    const batch = writeBatch(db);
                    const basePath = `/users/${userId}`;
                    
                    batch.delete(doc(db, `${basePath}/exercises`, id));
                    
                    const historyQuery = query(collection(db, `${basePath}/exerciseHistory`), where('exerciseId', '==', id));
                    const historySnapshot = await getDocs(historyQuery);
                    historySnapshot.forEach(d => batch.delete(d.ref));
                    
                    for (const sheet of state.sheets) {
                        const itemsQuery = query(collection(db, `${basePath}/workoutSheets/${sheet.id}/items`), where('exerciseIds', 'array-contains', id));
                        const itemsSnapshot = await getDocs(itemsQuery);
                        itemsSnapshot.forEach(d => {
                            const itemData = d.data();
                            const newExerciseIds = itemData.exerciseIds.filter(exId => exId !== id);
                            if(newExerciseIds.length > 0) {
                                batch.update(d.ref, { exerciseIds: newExerciseIds });
                            } else {
                                batch.delete(d.ref);
                            }
                        });
                    }

                    await batch.commit();
                    closeModal();
                    showToast("Esercizio eliminato con successo.", 'success');
                } catch (e) {
                    console.error("Errore eliminazione esercizio:", e);
                    showToast("Errore durante l'eliminazione.", 'error');
                }
            });
        }

        async function saveHistoryItem(exerciseId, historyId = null) {
            const { userId } = state;
            if (!userId) return showToast("Utente non autenticato.", 'error');
            const timestampStr = document.getElementById('history-timestamp').value;
            if (!timestampStr) return showToast("La data e l'ora sono obbligatorie.", 'error');
            const timestamp = Timestamp.fromDate(new Date(timestampStr));

            const diary = document.getElementById('history-diary').value.trim();
            const exercise = state.exercises.find(e => e.id === exerciseId);
            const params = {};
            let hasAnyParamValue = false;

            (exercise.parameters || []).forEach(paramName => {
                const sets = [];
                const paramId = sanitizeForId(paramName);
                document.querySelectorAll(`#sets-for-${paramId} > div`).forEach(setDiv => {
                    const set = {};
                    const inputs = setDiv.querySelectorAll('input');
                    let hasValueInSet = false;
                    inputs.forEach((input, index) => {
                        const val = input.value.trim();
                        if (val !== '') {
                            set[`val${index + 1}`] = val;
                            hasValueInSet = true;
                        } else {
                            set[`val${index + 1}`] = null;
                        }
                    });
                    
                    if (hasValueInSet) {
                        sets.push(set);
                        hasAnyParamValue = true;
                    }
                });

                if (sets.length > 0) {
                     const latestHistory = state.history
                        .filter(h => h.exerciseId === exerciseId && h.params?.[paramName] && h.id !== historyId)
                        .sort((a, b) => b.timestamp.seconds - a.timestamp.seconds)[0];
                    params[paramName] = {
                        value: JSON.stringify(sets),
                        previousValue: latestHistory?.params?.[paramName]?.value || null
                    };
                }
            });


            if (!hasAnyParamValue && !diary) {
                return showToast("Devi inserire almeno un valore per un parametro o una nota.", 'error');
            }
            
            const data = { exerciseId, timestamp, params, diary };
            const collectionPath = `/users/${userId}/exerciseHistory`;

            try {
                if (historyId) {
                    await setDoc(doc(db, collectionPath, historyId), data, { merge: true });
                } else {
                    await addDoc(collection(db, collectionPath), data);
                }
                await setDoc(doc(db, `/users/${userId}/exercises`, exerciseId), { updatedAt: serverTimestamp() }, { merge: true });
                closeModal();
                showToast("Documentazione salvata.", 'success');
            } catch(e) {
                console.error("Errore salvataggio storico:", e);
                showToast("Errore nel salvataggio.", 'error');
            }
        }
        
        async function deleteHistoryItem(id) {
            const { userId } = state;
            if (!userId) return showToast("Utente non autenticato.", 'error');
            showConfirm("Conferma Eliminazione", "Sei sicuro di voler eliminare questa voce dallo storico?", async () => {
                try {
                    await deleteDoc(doc(db, `/users/${userId}/exerciseHistory`, id));
                    showToast("Voce eliminata dallo storico.", 'success');
                } catch(e) {
                    console.error("Errore eliminazione storico:", e);
                    showToast("Errore durante l'eliminazione.", 'error');
                }
            });
        }
        
        async function saveSheet(id = null) {
            const { userId } = state;
            if (!userId) return showToast("Utente non autenticato.", 'error');
            const name = document.getElementById('sheet-name').value.trim();
            const description = document.getElementById('sheet-description').value.trim();
            const notes = document.getElementById('sheet-notes').value.trim();
            const containerId = document.getElementById('sheet-container').value || null;

            if (!name) return showToast("Il nome della scheda è obbligatorio.", 'error');

            const data = { name, description, notes, containerId, updatedAt: serverTimestamp() };
            const collectionPath = `/users/${userId}/workoutSheets`;

            try {
                if (id) {
                    await setDoc(doc(db, collectionPath, id), data, { merge: true });
                } else {
                    const q = query(collection(db, collectionPath));
                    const snapshot = await getDocs(q);
                    data.order = snapshot.size;
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, collectionPath), data);
                }
                closeModal();
                showToast(`Scheda "${name}" salvata.`, 'success');
            } catch(e) {
                console.error("Errore salvataggio scheda:", e);
                showToast("Errore nel salvataggio.", 'error');
            }
        }
        
        async function deleteSheet(id) {
            const { userId } = state;
            if (!userId) return showToast("Utente non autenticato.", 'error');
             showConfirm("Conferma Eliminazione", "Sei sicuro di voler eliminare questa scheda e tutti gli elementi al suo interno? (Azione non reversibile)", async () => {
                try {
                    const collectionPath = `/users/${userId}/workoutSheets/${id}/items`;
                    const itemsSnapshot = await getDocs(collection(db, collectionPath));
                    const batch = writeBatch(db);
                    itemsSnapshot.forEach(d => batch.delete(d.ref));
                    batch.delete(doc(db, `/users/${userId}/workoutSheets`, id));
                    await batch.commit();
                    showToast("Scheda eliminata.", 'success');
                } catch(e) {
                    console.error("Errore eliminazione scheda:", e);
                    showToast("Errore durante l'eliminazione.", 'error');
                }
            });
        }
        
        async function saveContainer(id = null) {
            const { userId } = state;
            if (!userId) return showToast("Utente non autenticato.", 'error');
            const name = document.getElementById('container-name').value.trim();
            const description = document.getElementById('container-description').value.trim();
            const color = document.getElementById('container-color').value;
            if (!name) return showToast("Il nome del contenitore è obbligatorio.", 'error');
            
            const data = { name, description, color, updatedAt: serverTimestamp() };
            const collectionPath = `/users/${userId}/sheetContainers`;
            try {
                if (id) {
                    await setDoc(doc(db, collectionPath, id), data, { merge: true });
                } else {
                    const q = query(collection(db, collectionPath));
                    const snapshot = await getDocs(q);
                    data.order = snapshot.size;
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, collectionPath), data);
                }
                closeModal();
                showToast(`Contenitore "${name}" salvato.`, 'success');
            } catch (e) {
                console.error("Errore salvataggio contenitore:", e);
                showToast("Errore durante il salvataggio.", 'error');
            }
        }

        async function deleteContainer(id) {
            const { userId } = state;
            if (!userId) return showToast("Utente non autenticato.", 'error');
            const container = state.sheetContainers.find(c => c.id === id);
            if (!container) return;
             showConfirm("Conferma Eliminazione", `Sei sicuro di voler eliminare il contenitore "<strong>${container.name}</strong>"? Le schede al suo interno non verranno eliminate, ma saranno spostate in "non assegnate".`, async () => {
                 try {
                    const batch = writeBatch(db);
                    const sheetsInContainer = state.sheets.filter(s => s.containerId === id);
                    sheetsInContainer.forEach(sheet => {
                        const sheetRef = doc(db, `/users/${userId}/workoutSheets`, sheet.id);
                        batch.update(sheetRef, { containerId: null });
                    });
                    const containerRef = doc(db, `/users/${userId}/sheetContainers`, id);
                    batch.delete(containerRef);
                    await batch.commit();
                    showToast("Contenitore eliminato.", 'success');
                } catch(e) {
                    console.error("Errore eliminazione contenitore:", e);
                    showToast("Errore durante l'eliminazione.", 'error');
                }
             });
        }

        // --- LOGICA SCHEDE ALLENAMENTO ---
        
        async function saveItemsToSheet(sheetId, itemsToAdd) {
            const { userId } = state;
            if (!userId) return showToast("Utente non autenticato.", 'error');

            if (itemsToAdd.length === 0) return showToast("Nessun elemento valido da aggiungere.", 'error');
            
            try {
                const currentItems = state.sheetItems[sheetId] || [];
                let maxOrder = currentItems.reduce((max, item) => Math.max(max, item.order), -1);
                const collectionPath = `/users/${userId}/workoutSheets/${sheetId}/items`;

                const batch = writeBatch(db);
                itemsToAdd.forEach(itemData => {
                    maxOrder++;
                    const newItem = {
                        ...itemData,
                        order: maxOrder,
                        isDone: false,
                        isDeactivated: false,
                        createdAt: serverTimestamp()
                    };
                    const itemRef = doc(collection(db, collectionPath));
                    batch.set(itemRef, newItem);
                });

                await batch.commit();
                closeModal();
                showToast(`${itemsToAdd.length} elemento(i) aggiunto(i) alla scheda.`, 'success');
            } catch (e) {
                console.error("Errore aggiunta elementi alla scheda:", e);
                showToast("Errore durante l'aggiunta.", 'error');
            }
        }
        
        async function resetSheetDoneStatus(sheetId) {
            const { userId } = state;
            if (!userId) return showToast("Utente non autenticato.", 'error');
            showConfirm("Resetta Stato", "Sei sicuro di voler segnare tutti gli esercizi di questa scheda come 'da fare'?", async () => {
                const items = state.sheetItems[sheetId] || [];
                const batch = writeBatch(db);
                const collectionPath = `/users/${userId}/workoutSheets/${sheetId}/items`;
                items.forEach(item => {
                    if (item.type === 'exercise') {
                        const itemRef = doc(db, collectionPath, item.id);
                        batch.update(itemRef, { isDone: false });
                    }
                });
                try {
                    await batch.commit();
                    showToast("Stato degli esercizi resettato.", 'success');
                } catch(e) { console.error(e); showToast("Errore durante il reset.", 'error'); }
            });
        }
        
        async function toggleSheetItemDone(sheetId, itemId, isDone) {
            const { userId } = state;
            if (!userId) return;
            try {
                const docRef = doc(db, `/users/${userId}/workoutSheets/${sheetId}/items`, itemId);
                await updateDoc(docRef, { isDone });
            } catch(e) { console.error(e); showToast("Errore aggiornamento stato.", 'error'); }
        }
        
        async function reorderSheetItem(sheetId, itemId, direction) {
            const { userId } = state;
            if (!userId) return;
            const items = [...(state.sheetItems[sheetId] || [])].sort((a,b) => a.order - b.order);
            const currentIndex = items.findIndex(item => item.id === itemId);
            if (currentIndex === -1) return;

            const targetIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (targetIndex < 0 || targetIndex >= items.length) return;

            const currentItem = items[currentIndex];
            const targetItem = items[targetIndex];
            
            const batch = writeBatch(db);
            const collectionPath = `/users/${userId}/workoutSheets/${sheetId}/items`;
            const currentRef = doc(db, collectionPath, currentItem.id);
            const targetRef = doc(db, collectionPath, targetItem.id);

            batch.update(currentRef, { order: targetItem.order });
            batch.update(targetRef, { order: currentItem.order });

            try {
                await batch.commit();
            } catch(e) { console.error(e); showToast("Errore riordinamento.", 'error'); }
        }

        async function reorderEntity(type, entityId, direction) {
            const { userId } = state;
            if (!userId) return;

            let list;
            let collectionPath;
            
            if (type === 'container') {
                list = [...state.sheetContainers];
                collectionPath = `/users/${userId}/sheetContainers`;
            } else if (type === 'sheet') {
                const currentSheet = state.sheets.find(s => s.id === entityId);
                if (!currentSheet) return;

                if (currentSheet.containerId) {
                    list = state.sheets.filter(s => s.containerId === currentSheet.containerId);
                } else {
                    list = state.sheets.filter(s => !s.containerId);
                }
                collectionPath = `/users/${userId}/workoutSheets`;
            } else {
                return;
            }

            list.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));

            const currentIndex = list.findIndex(item => item.id === entityId);
            if (currentIndex === -1) return;

            const targetIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (targetIndex < 0 || targetIndex >= list.length) return;

            const currentItem = list[currentIndex];
            const targetItem = list[targetIndex];

            const batch = writeBatch(db);

            const needsOrderMigration = list.some(item => typeof item.order !== 'number');
            if (needsOrderMigration) {
                list.forEach((item, index) => {
                    const itemRef = doc(db, collectionPath, item.id);
                    batch.update(itemRef, { order: index });
                });
                currentItem.order = currentIndex;
                targetItem.order = targetIndex;
            }

            const currentRef = doc(db, collectionPath, currentItem.id);
            const targetRef = doc(db, collectionPath, targetItem.id);
            batch.update(currentRef, { order: targetItem.order });
            batch.update(targetRef, { order: currentItem.order });

            try {
                await batch.commit();
            } catch (e) {
                console.error("Errore durante il riordinamento:", e);
                showToast("Errore durante il riordinamento.", 'error');
            }
        }


        async function deleteSheetItem(sheetId, itemId) {
            const { userId } = state;
            if (!userId) return;
             showConfirm("Elimina Elemento", "Sei sicuro di voler eliminare questo elemento dalla scheda?", async () => {
                 try {
                    const docRef = doc(db, `/users/${userId}/workoutSheets/${sheetId}/items`, itemId);
                     await deleteDoc(docRef);
                     showToast("Elemento rimosso.", 'success');
                 } catch(e) { console.error(e); showToast("Errore eliminazione.", 'error'); }
             });
        }
        
        function openSheetItemActions(sheetId, itemId) {
            const item = (state.sheetItems[sheetId] || []).find(i => i.id === itemId);
            if (!item) return;

            const editAction = item.type === 'pause' || item.type === 'text' ? `
                <button id="edit-item-btn" class="material-button material-button-text w-full justify-start">Modifica</button>` : '';

            const carousel = document.querySelector(`#carousel-${itemId}`);
            const currentIndex = carousel ? parseInt(carousel.dataset.currentIndex) : 0;
            const currentExerciseId = (item.exerciseIds || [])[currentIndex] || (item.exerciseIds || [])[0];
            if (!currentExerciseId) return;

            const currentExercise = state.exercises.find(ex => ex.id === currentExerciseId);
            const currentLabels = (item.labels && Array.isArray(item.labels[currentExerciseId])) ? item.labels[currentExerciseId] : [];

            const renderLabelForm = () => {
                if (currentLabels.length >= 3) return '<p class="text-sm text-gray-500">Massimo 3 etichette.</p>';
                return `
                    <div class="flex gap-2">
                         <input type="text" id="label-text" placeholder="Testo etichetta" class="input-field !p-2 flex-grow">
                         <input type="hidden" id="label-color" value="${COLORS[0]}">
                    </div>
                    <div class="flex flex-wrap gap-2 mt-2">
                        ${COLORS.map(c => `<div onclick="document.getElementById('label-color').value='${c}'; document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('selected')); this.classList.add('selected');" class="color-dot ${COLORS[0] === c ? 'selected' : ''}" style="background-color:${c}"></div>`).join('')}
                    </div>
                     <div class="flex justify-end gap-2 mt-2">
                        <button id="save-label-btn" class="material-button material-button-outlined text-sm">Aggiungi Etichetta</button>
                    </div>
                `;
            }

            const labelAction = item.type === 'exercise' ? `
                <div class="mt-2 border-t pt-2">
                    <p class="text-sm font-medium mb-2">Etichette per: <strong>${currentExercise.name}</strong></p>
                    <div class="space-y-2 mb-4">
                    ${currentLabels.map((label, index) => `
                        <div class="flex justify-between items-center bg-gray-100 p-2 rounded">
                            <span class="text-sm font-medium px-2 py-1 rounded-full" style="background-color:${label.color}; color: #fff;">${label.text}</span>
                            <button onclick="window.app.removeSheetItemLabel('${sheetId}', '${itemId}', '${currentExerciseId}', ${index})" class="material-button-text p-1 rounded-full"><span class="material-icons text-sm">close</span></button>
                        </div>
                    `).join('')}
                    </div>
                    ${renderLabelForm()}
                </div>
            ` : '';
            
            modalContainer.innerHTML = `
                <div class="modal-content p-6 overflow-y-auto">
                    <h3 class="text-xl font-medium mb-4">Azioni Elemento</h3>
                    <div class="space-y-2">
                        ${editAction}
                        <button id="toggle-deactivate-btn" class="material-button material-button-text w-full justify-start">${item.isDeactivated ? 'Riattiva' : 'Disattiva Temporaneamente'}</button>
                        <button id="delete-item-btn" class="material-button material-button-text w-full justify-start text-red-600">Elimina dalla scheda</button>
                    </div>
                    ${labelAction}
                     <div class="flex justify-end gap-2 mt-6 border-t pt-4">
                        <button onclick="window.app.closeModal()" class="material-button material-button-text">Chiudi</button>
                    </div>
                </div>
            `;
            
            if (document.getElementById('edit-item-btn')) {
                document.getElementById('edit-item-btn').onclick = () => editSheetItem(sheetId, itemId, item.type);
            }
            document.getElementById('toggle-deactivate-btn').onclick = () => toggleSheetItemDeactivated(sheetId, itemId, !item.isDeactivated);
            document.getElementById('delete-item-btn').onclick = () => { closeModal(); deleteSheetItem(sheetId, itemId); };
            
            const saveLabelBtn = document.getElementById('save-label-btn');
            if (saveLabelBtn) {
                saveLabelBtn.onclick = () => {
                    const text = document.getElementById('label-text').value.trim();
                    const color = document.getElementById('label-color').value;
                    if (text) {
                        const newLabel = { text, color };
                        const updatedLabels = [...currentLabels, newLabel];
                        updateSheetItemLabel(sheetId, itemId, currentExerciseId, updatedLabels);
                    }
                };
            }

            modalContainer.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        async function toggleSheetItemDeactivated(sheetId, itemId, isDeactivated) {
            const { userId } = state;
            if (!userId) return;
            try {
                const docRef = doc(db, `/users/${userId}/workoutSheets/${sheetId}/items`, itemId);
                await updateDoc(docRef, { isDeactivated });
                closeModal();
                showToast(`Elemento ${isDeactivated ? 'disattivato' : 'riattivato'}.`, 'success');
            } catch(e) { console.error(e); showToast("Errore aggiornamento.", 'error'); }
        }

        async function updateSheetItemLabel(sheetId, itemId, exerciseId, labelsArray) {
            const { userId } = state;
            if (!userId) return;
             try {
                const docRef = doc(db, `/users/${userId}/workoutSheets/${sheetId}/items`, itemId);
                const labelKey = `labels.${exerciseId}`;
                await updateDoc(docRef, { [labelKey]: labelsArray });
                closeModal();
            } catch(e) { console.error(e); showToast("Errore aggiornamento etichetta.", 'error'); }
        }
        
        function editSheetItem(sheetId, itemId, type) {
            const item = (state.sheetItems[sheetId] || []).find(i => i.id === itemId);
            if (!item) return;
            
            let content = '';
            if (type === 'pause') {
                const minutes = Math.floor(item.duration / 60);
                const seconds = item.duration % 60;
                content = `
                    <h3 class="text-xl font-medium mb-4">Modifica Pausa</h3>
                    <div class="flex gap-2 items-center">
                        <input type="number" id="pause-minutes" placeholder="Minuti" class="input-field !p-2 w-1/2" value="${minutes}">
                        <input type="number" id="pause-seconds" placeholder="Secondi" class="input-field !p-2 w-1/2" value="${seconds}">
                    </div>`;
            } else { // text
                content = `
                    <h3 class="text-xl font-medium mb-4">Modifica Testo</h3>
                    <textarea id="text-content" class="input-field min-h-[100px]">${item.text}</textarea>`;
            }
            
            modalContainer.innerHTML = `
                <div class="modal-content p-6">
                    ${content}
                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="window.app.closeModal()" class="material-button material-button-text">Annulla</button>
                        <button id="save-item-changes-btn" class="material-button material-button-filled">Salva Modifiche</button>
                    </div>
                </div>
            `;
            modalContainer.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            document.getElementById('save-item-changes-btn').onclick = async () => {
                const { userId } = state;
                if (!userId) return;
                let data = {};
                if (type === 'pause') {
                    const minutes = parseInt(document.getElementById('pause-minutes').value) || 0;
                    const seconds = parseInt(document.getElementById('pause-seconds').value) || 0;
                    data.duration = minutes * 60 + seconds;
                } else {
                    data.text = document.getElementById('text-content').value.trim();
                }
                try {
                    const docRef = doc(db, `/users/${userId}/workoutSheets/${sheetId}/items`, itemId);
                    await updateDoc(docRef, data);
                    closeModal();
                    showToast("Elemento aggiornato.", 'success');
                } catch(e) { console.error(e); showToast("Errore aggiornamento.", 'error'); }
            };
        }

        // --- LOGICA TIMER ---
        function stopAllTimers() {
            Object.values(state.timers).forEach(timer => {
                if (timer.intervalId) clearInterval(timer.intervalId);
            });
            state.timers = {};
        }

        function toggleTimer(itemId, duration) {
            const timerId = `timer-${itemId}`;
            if (state.timers[timerId]?.intervalId) {
                clearInterval(state.timers[timerId].intervalId);
                state.timers[timerId].intervalId = null;
            } else { 
                if (!state.timers[timerId]) {
                    state.timers[timerId] = { remaining: duration, isFinished: false };
                }
                state.timers[timerId].isFinished = false;
                state.timers[timerId].intervalId = setInterval(() => {
                    state.timers[timerId].remaining--;
                    const timerEl = document.getElementById(timerId);
                    if (timerEl) timerEl.innerText = formatTime(state.timers[timerId].remaining);
                    if (state.timers[timerId].remaining <= 0) {
                        clearInterval(state.timers[timerId].intervalId);
                        state.timers[timerId].intervalId = null;
                        state.timers[timerId].isFinished = true;
                        if (timerEl) timerEl.classList.add('blinking');
                    }
                }, 1000);
            }
             if(!state.isWorkoutModeActive) render();
             else {
                 const playPauseButton = document.querySelector(`#workout-item-content button[onclick*="toggleTimer"] span`);
                 if(playPauseButton) playPauseButton.textContent = state.timers[timerId]?.intervalId ? 'pause' : 'play_arrow';
             }
        }

        function resetTimer(itemId, duration) {
            const timerId = `timer-${itemId}`;
            if (state.timers[timerId]?.intervalId) {
                clearInterval(state.timers[timerId].intervalId);
            }
            state.timers[timerId] = { remaining: duration, intervalId: null, isFinished: false };
            const timerEl = document.getElementById(timerId);
            if(timerEl) {
                timerEl.innerText = formatTime(duration);
                timerEl.classList.remove('blinking');
            }
            if(!state.isWorkoutModeActive) render();
            else {
                 const playPauseButton = document.querySelector(`#workout-item-content button[onclick*="toggleTimer"] span`);
                 if(playPauseButton) playPauseButton.textContent = 'play_arrow';
            }
        }
        
        // --- LOGICA MODALITÀ ALLENAMENTO ---
        
        function openWorkoutSelectionModal() {
            const hasUnassigned = state.sheets.some(s => !s.containerId);
            modalContainer.innerHTML = `
                <div class="modal-content p-6">
                    <h3 class="text-xl font-medium mb-4">Scegli un Contenitore</h3>
                     <div class="space-y-2 max-h-80 overflow-y-auto">
                        ${state.sheetContainers.map(c => `
                            <div onclick="window.app.renderWorkoutSheetSelection('${c.id}')" class="p-4 rounded-lg hover:bg-gray-100 cursor-pointer border" style="border-left: 4px solid ${c.color || '#6750A4'}">
                                ${c.name}
                            </div>
                        `).join('')}
                        ${hasUnassigned ? `
                            <div onclick="window.app.renderWorkoutSheetSelection(null)" class="p-4 rounded-lg hover:bg-gray-100 cursor-pointer border">
                                Schede non assegnate
                            </div>
                        ` : ''}
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="window.app.closeModal()" class="material-button material-button-text">Annulla</button>
                    </div>
                </div>`;
            
            modalContainer.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function renderWorkoutSheetSelection(containerId) {
            const sheets = state.sheets.filter(s => s.containerId === containerId);
            const content = document.querySelector('#modal-container .modal-content');
            if(!content) return;
            content.innerHTML = `
                <h3 class="text-xl font-medium mb-4">Scegli una Scheda</h3>
                <div class="space-y-2 max-h-80 overflow-y-auto">
                    ${sheets.length > 0 ? sheets.map(s => `
                        <div onclick="window.app.startWorkout('${s.id}')" class="p-4 rounded-lg hover:bg-gray-100 cursor-pointer border">
                            <p class="font-medium">${s.name}</p>
                            <p class="text-sm text-gray-500">${s.description || ''}</p>
                        </div>
                    `).join('') : '<p class="text-gray-500 text-center">Nessuna scheda in questo contenitore.</p>'}
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button onclick="window.app.openWorkoutSelectionModal()" class="material-button material-button-text">Indietro</button>
                </div>
            `;
        }

        function startWorkout(sheetId) {
            closeModal();
            const sheet = state.sheets.find(s => s.id === sheetId);
            if (!sheet) return showToast("Scheda non trovata", 'error');

            const items = (state.sheetItems[sheetId] || [])
                .filter(item => !item.isDeactivated)
                .sort((a,b) => a.order - b.order);

            if (items.length === 0) return showToast("Questa scheda è vuota!", 'error');

            state.isWorkoutModeActive = true;
            state.workout = {
                sheetId: sheetId,
                sheetName: sheet.name,
                items: items,
                currentItemIndex: 0,
                startTime: new Date(),
                globalTimerIntervalId: null,
                elapsedSeconds: 0,
            };
            
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('workout-mode-container').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');

            startGlobalTimer();
            renderWorkoutStep();
        }

        function renderWorkoutStep() {
            if (!state.workout) return;

            const { items, currentItemIndex, sheetName } = state.workout;
            const item = items[currentItemIndex];
            
            document.getElementById('workout-sheet-name').textContent = sheetName;
            document.getElementById('workout-step-counter').textContent = `Passaggio ${currentItemIndex + 1} / ${items.length}`;

            const contentDiv = document.getElementById('workout-item-content');
            
            let html = '';
            switch (item.type) {
                case 'exercise': html = renderExerciseItem(item, state.workout.sheetId, currentItemIndex, items.length); break;
                case 'pause': html = renderPauseItem(item, state.workout.sheetId, currentItemIndex, items.length); break;
                case 'text': html = renderTextItem(item, state.workout.sheetId, currentItemIndex, items.length); break;
            }
            contentDiv.innerHTML = html;
            
            document.getElementById('workout-prev-btn').disabled = currentItemIndex === 0;
            const isLastStep = currentItemIndex >= items.length - 1;
            document.getElementById('workout-navigation').classList.toggle('hidden', isLastStep);
            document.getElementById('workout-finish-view').classList.toggle('hidden', !isLastStep);
        }
        
        function workoutNextStep() {
            if (!state.workout || state.workout.currentItemIndex >= state.workout.items.length - 1) return;
            state.workout.currentItemIndex++;
            renderWorkoutStep();
        }
        
        function workoutPrevStep() {
             if (!state.workout || state.workout.currentItemIndex <= 0) return;
            state.workout.currentItemIndex--;
            renderWorkoutStep();
        }
        
        function endWorkout() {
            document.getElementById('confirm-title').innerText = 'Termina Allenamento';
            document.getElementById('confirm-message').innerHTML = 'Vuoi salvare questa sessione prima di uscire?';
            const confirmModal = document.getElementById('confirm-modal');
            const buttonContainer = document.getElementById('confirm-buttons');
            
            buttonContainer.innerHTML = `
                <button id="custom-cancel" class="material-button material-button-text">Annulla</button>
                <button id="custom-discard" class="material-button material-button-outlined !border-red-500 !text-red-500">Esci senza salvare</button>
                <button id="custom-save" class="material-button material-button-filled">Salva ed Esci</button>
            `;

            confirmModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            const close = () => {
                confirmModal.classList.add('hidden');
                 document.body.classList.remove('overflow-hidden');
            };

            document.getElementById('custom-save').onclick = async () => {
                stopGlobalTimer();
                const workoutData = { ...state.workout, endTime: new Date() };
                await saveWorkoutSession(workoutData);
                close();
                exitWorkoutMode();
            };
             document.getElementById('custom-discard').onclick = () => {
                close();
                exitWorkoutMode();
            };
            document.getElementById('custom-cancel').onclick = close;
        }

        async function finishAndSaveWorkout() {
            stopGlobalTimer();
            const workoutData = { ...state.workout, endTime: new Date() };
            const finalBtn = document.getElementById('end-workout-btn-final');
            if (finalBtn) {
                finalBtn.disabled = true;
                finalBtn.textContent = 'Salvataggio...';
            }
            await saveWorkoutSession(workoutData);
            exitWorkoutMode();
        }
        
        async function saveWorkoutSession(workoutData) {
            const { userId } = state;
            if (!userId || !workoutData) {
                showToast("Dati utente o allenamento mancanti per il salvataggio.", "error");
                return;
            }
            const dataToSave = {
                sheetId: workoutData.sheetId,
                sheetName: workoutData.sheetName,
                startTime: Timestamp.fromDate(workoutData.startTime),
                endTime: Timestamp.fromDate(workoutData.endTime),
                durationSeconds: workoutData.elapsedSeconds,
            };
            try {
                await addDoc(collection(db, `/users/${userId}/workoutSessions`), dataToSave);
                showToast("Sessione salvata con successo!", "success");
            } catch(e) {
                console.error("Errore salvataggio sessione:", e);
                showToast("Errore durante il salvataggio della sessione.", "error");
            }
        }
        
        function exitWorkoutMode() {
            stopGlobalTimer();
            stopAllTimers();
            state.isWorkoutModeActive = false;
            state.workout = null;
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('workout-mode-container').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            const finalBtn = document.getElementById('end-workout-btn-final');
            if(finalBtn) {
                finalBtn.disabled = false;
                finalBtn.textContent = 'Termina e Salva';
            }
            navigate('history');
        }

        function startGlobalTimer() {
            if (state.workout?.globalTimerIntervalId) clearInterval(state.workout.globalTimerIntervalId);
            state.workout.elapsedSeconds = 0;
            document.getElementById('workout-global-timer').textContent = formatGlobalTime(0);
            state.workout.globalTimerIntervalId = setInterval(() => {
                state.workout.elapsedSeconds++;
                document.getElementById('workout-global-timer').textContent = formatGlobalTime(state.workout.elapsedSeconds);
            }, 1000);
        }

        function stopGlobalTimer() {
             if (state.workout?.globalTimerIntervalId) {
                clearInterval(state.workout.globalTimerIntervalId);
                state.workout.globalTimerIntervalId = null;
            }
        }
        
        // --- INIZIO BLOCCO NUOVE FUNZIONI (VARIANTS) ---

        function openAddVariantModal(sheetId, itemId, primaryExerciseId) {
            const primaryExercise = state.exercises.find(ex => ex.id === primaryExerciseId);
            if (!primaryExercise) return showToast("Esercizio principale non trovato.", "error");

            modalContainer.innerHTML = `
                <div class="modal-content p-6">
                    <h3 class="text-xl font-medium mb-2">Aggiungi Alternativa</h3>
                    <p class="text-sm text-gray-500 mb-6">Per: <strong>${primaryExercise.name}</strong></p>
                    <div class="flex flex-col gap-4">
                        <button onclick="window.app.openVariantDbSelector('${sheetId}', '${itemId}')" class="material-button material-button-outlined w-full">Scegli dal Database</button>
                        <button onclick="window.app.openVariantAiGenerator('${sheetId}', '${itemId}', '${primaryExerciseId}')" class="material-button material-button-filled w-full">✨ Genera con AI</button>
                    </div>
                    <div class="flex justify-end gap-2 mt-8">
                        <button onclick="window.app.closeModal()" class="material-button material-button-text">Annulla</button>
                    </div>
                </div>
            `;
            modalContainer.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function openVariantDbSelector(sheetId, itemId) {
            const item = (state.sheetItems[sheetId] || []).find(i => i.id === itemId);
            const existingIds = item?.exerciseIds || (item?.exerciseId ? [item.exerciseId] : []);
            
            const availableExercises = state.exercises.filter(ex => !existingIds.includes(ex.id));

            modalContainer.innerHTML = `
                <div class="modal-content p-6 flex flex-col">
                    <h3 class="text-xl font-medium mb-4">Scegli un Esercizio</h3>
                    <select id="variant-exercise-select" class="input-field">
                        <option value="">Seleziona...</option>
                        ${state.categories.map(cat => `
                            <optgroup label="${cat.name}">
                                ${availableExercises.filter(ex => ex.categoryId === cat.id).map(ex => `
                                    <option value="${ex.id}">${ex.name}</option>
                                `).join('')}
                            </optgroup>
                        `).join('')}
                         <optgroup label="Non Categorizzati">
                                ${availableExercises.filter(ex => !ex.categoryId).map(ex => `
                                    <option value="${ex.id}">${ex.name}</option>
                                `).join('')}
                         </optgroup>
                    </select>
                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="window.app.closeModal()" class="material-button material-button-text">Annulla</button>
                        <button id="add-variant-btn" class="material-button material-button-filled">Aggiungi</button>
                    </div>
                </div>
            `;
             document.getElementById('add-variant-btn').onclick = () => {
                const selectedId = document.getElementById('variant-exercise-select').value;
                if (selectedId) {
                    addVariantToSheetItem(sheetId, itemId, selectedId);
                    closeModal();
                } else {
                    showToast("Seleziona un esercizio.", "error");
                }
            };
        }

        async function addVariantToSheetItem(sheetId, itemId, newExerciseId, labels = null) {
            const item = (state.sheetItems[sheetId] || []).find(i => i.id === itemId);
            if (!item) return;
            
            const currentIds = item.exerciseIds || (item.exerciseId ? [item.exerciseId] : []);
            if(currentIds.includes(newExerciseId)) return;

            const newIds = [...currentIds, newExerciseId];
            const dataToUpdate = { exerciseIds: newIds };

            if(labels) {
                 dataToUpdate[`labels.${newExerciseId}`] = labels;
            }
            
            try {
                const docRef = doc(db, `/users/${state.userId}/workoutSheets/${sheetId}/items`, itemId);
                await updateDoc(docRef, dataToUpdate);
                showToast("Alternativa aggiunta.", "success");
            } catch (e) {
                console.error("Errore aggiunta variante:", e);
                showToast("Errore durante l'aggiunta.", "error");
            }
        }
        
        async function removeVariantFromSheetItem(sheetId, itemId, exerciseIdToRemove) {
             const item = (state.sheetItems[sheetId] || []).find(i => i.id === itemId);
            if (!item) return;

            const currentIds = item.exerciseIds || (item.exerciseId ? [item.exerciseId] : []);
            const newIds = currentIds.filter(id => id !== exerciseIdToRemove);
            
            if(newIds.length === 0) return showToast("Non puoi rimuovere l'esercizio principale.", "error");

            try {
                const docRef = doc(db, `/users/${state.userId}/workoutSheets/${sheetId}/items`, itemId);
                await updateDoc(docRef, { 
                    exerciseIds: newIds,
                    [`labels.${exerciseIdToRemove}`]: null
                });
                showToast("Alternativa rimossa.", "success");
            } catch (e) {
                console.error("Errore rimozione variante:", e);
                showToast("Errore durante la rimozione.", "error");
            }
        }
        
        function openVariantAiGenerator(sheetId, itemId, primaryExerciseId) {
            modalContainer.innerHTML = `
                <div class="modal-content p-6 overflow-y-auto">
                    <h3 class="text-xl font-medium mb-1">✨ Genera Alternativa con AI</h3>
                    <p class="text-sm text-gray-500 mb-6">L'AI creerà un nuovo esercizio e lo aggiungerà al tuo database.</p>
                    <div id="ai-variant-form">
                        <label for="ai-discipline" class="text-sm font-medium text-gray-700">Scegli una disciplina o contesto</label>
                        <select id="ai-discipline" class="input-field mt-1">
                            <option value="Palestra">Palestra (con attrezzi)</option>
                            <option value="Corpo Libero">Corpo Libero</option>
                            <option value="Cardio">Cardio</option>
                            <option value="Atletica Leggera">Atletica Leggera</option>
                            <option value="Calisthenics">Calisthenics</option>
                            <option value="Stretching">Stretching / Mobilità</option>
                        </select>
                    </div>
                    <div id="ai-variant-loader" class="hidden text-center py-8">
                        <div class="flex justify-center mb-4"><div class="loader"></div></div>
                        <p>L'AI sta creando la tua alternativa...</p>
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="window.app.closeModal()" class="material-button material-button-text">Annulla</button>
                        <button id="generate-ai-variant-btn" class="material-button material-button-filled">✨ Genera</button>
                    </div>
                </div>
            `;
            document.getElementById('generate-ai-variant-btn').onclick = () => generateAiVariant(sheetId, itemId, primaryExerciseId);
        }

        async function generateAiVariant(sheetId, itemId, primaryExerciseId) {
            const primaryExercise = state.exercises.find(ex => ex.id === primaryExerciseId);
            if (!primaryExercise) return showToast("Esercizio principale non trovato.", "error");

            const discipline = document.getElementById('ai-discipline').value;
            
            document.getElementById('ai-variant-form').classList.add('hidden');
            document.getElementById('generate-ai-variant-btn').classList.add('hidden');
            document.getElementById('ai-variant-loader').classList.remove('hidden');

            const existingExerciseNames = state.exercises.map(ex => `"${ex.name}"`).join(', ');

            const prompt = `Sei un esperto personal trainer. L'utente vuole un'alternativa all'esercizio "${primaryExercise.name}" che allena principalmente "${primaryExercise.zone || 'una zona corporea simile'}".
            L'alternativa deve appartenere alla disciplina "${discipline}".

            IMPORTANTE: L'utente ha già i seguenti esercizi nel suo database: [${existingExerciseNames}].
            NON generare un esercizio con uno di questi nomi. La tua risposta DEVE essere un esercizio NUOVO e UNICO.
            
            Forniscimi una risposta ESCLUSIVAMENTE in formato JSON con la seguente struttura:
            {
              "name": "Nome del nuovo esercizio",
              "zone": "${primaryExercise.zone || ''}",
              "parameters": ["Parametro 1", "Parametro 2"],
              "aiDetails": "Una spiegazione dettagliata dell'esercizio in formato HTML, che includa 'Esecuzione Corretta', 'Muscoli Coinvolti' e 'Errori Comuni'."
            }
            Assicurati che 'parameters' sia un array di stringhe e che 'aiDetails' sia una stringa HTML ben formattata.`;

            const responseJsonString = await callGeminiAPI(prompt, true);
            if (!responseJsonString) {
                closeModal();
                return;
            }

            try {
                const newExerciseData = JSON.parse(responseJsonString);
                
                // Fallback check in case the AI ignores the instruction
                const isDuplicate = state.exercises.some(ex => ex.name.trim().toLowerCase() === newExerciseData.name.trim().toLowerCase());
                if (isDuplicate) {
                    showToast("L'AI ha generato un duplicato. Per favore, riprova.", "error");
                    closeModal();
                    return;
                }
                
                // 1. Aggiungi il nuovo esercizio al database
                const exerciseCollection = collection(db, `/users/${state.userId}/exercises`);
                const newExerciseRef = await addDoc(exerciseCollection, {
                    ...newExerciseData,
                    categoryId: primaryExercise.categoryId || null,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });

                // 2. Aggiungi la variante alla scheda con l'etichetta AI
                const aiLabel = { text: "AI", color: "#f59e0b" };
                await addVariantToSheetItem(sheetId, itemId, newExerciseRef.id, [aiLabel]);
                
                closeModal();
                showToast("Alternativa AI generata e aggiunta!", "success");

            } catch(e) {
                console.error("Errore durante la generazione dell'alternativa AI:", e);
                showToast("L'AI ha restituito un formato non valido. Riprova.", "error");
                closeModal();
            }
        }

        // --- FINE BLOCCO NUOVE FUNZIONI (VARIANTS) ---

        // --- SETUP INIZIALE ---
        
        window.app = {
            closeModal, openCategoryModal, deleteCategory, openExerciseModal, deleteExercise,
            openAddHistoryModal, deleteHistoryItem,
            addParameterField() {
                const container = document.getElementById('parameters-list');
                const div = document.createElement('div');
                div.className = "flex items-center gap-2";
                div.innerHTML = `<input type="text" class="input-field !p-2 flex-grow" placeholder="Es: Peso, Ripetizioni..."><button onclick="this.parentElement.remove()" class="material-button-text p-2 rounded-full"><span class="material-icons">remove_circle_outline</span></button>`;
                container.appendChild(div);
            },
            addParamSet(paramId) {
                const container = document.getElementById(`sets-for-${paramId}`);
                const index = container.children.length;
                const div = document.createElement('div');
                div.className = "flex gap-1.5 items-center";
                div.dataset.setIndex = index;
                div.innerHTML = `<input type="text" placeholder="" class="input-field !p-2 flex-1" value=""><button onclick="window.app.addInputFieldToSet(this)" class="material-button-text p-2 rounded-full !min-w-0"><span class="material-icons">add</span></button><button onclick="this.parentElement.remove()" class="material-button-text p-2 rounded-full !min-w-0"><span class="material-icons">remove_circle_outline</span></button>`;
                container.appendChild(div);
            },
            addInputFieldToSet(buttonElement) {
                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.placeholder = '';
                newInput.className = 'input-field !p-2 flex-1';
                buttonElement.parentElement.insertBefore(newInput, buttonElement);
            },
            openSheetModal, deleteSheet, addItemsToSheet, resetSheetDoneStatus,
            toggleSheetItemDone, reorderSheetItem, openSheetItemActions,
            deleteSheetItem, toggleTimer, resetTimer, openContainerModal, deleteContainer,
            toggleExpansion, reorderEntity,
            openWorkoutSelectionModal, renderWorkoutSheetSelection, startWorkout,
            deleteWorkoutSession(sessionId) {
                if (!sessionId) return;
                showConfirm("Elimina Sessione", "Sei sicuro di voler eliminare questa sessione di allenamento dallo storico? L'azione è irreversibile.", async () => {
                    try {
                        await deleteDoc(doc(db, `/users/${state.userId}/workoutSessions`, sessionId));
                        showToast("Sessione eliminata.", "success");
                    } catch(e) {
                        console.error("Errore eliminazione sessione:", e);
                        showToast("Errore durante l'eliminazione.", "error");
                    }
                });
            },
            toggleExtraSessions(sheetId, remainingCount) {
                const extraDiv = document.getElementById(`extra-sessions-${sheetId}`);
                const btn = document.getElementById(`toggle-sessions-btn-${sheetId}`);
                if (!extraDiv || !btn) return;
                
                const isHidden = extraDiv.classList.contains('hidden');
                extraDiv.classList.toggle('hidden');
                
                if (isHidden) {
                    btn.textContent = 'Mostra Meno';
                } else {
                    btn.textContent = `Mostra Altri ${remainingCount}`;
                }
            },
            navigateCarousel(carouselId, direction) {
                const container = document.getElementById(carouselId)?.parentElement;
                if (!container) return;
                const track = container.querySelector('.variant-carousel-track');
                const slides = container.querySelectorAll('.variant-slide');
                const dotsContainer = container.parentElement.querySelector('.variant-dots');
                if (!dotsContainer) return;
                const dots = dotsContainer.querySelectorAll('.variant-dot');
                
                let currentIndex = parseInt(container.querySelector('.variant-carousel-container').dataset.currentIndex || '0');
                let newIndex = currentIndex + direction;

                if (newIndex < 0) newIndex = slides.length - 1;
                if (newIndex >= slides.length) newIndex = 0;

                track.style.transform = `translateX(-${newIndex * 100}%)`;
                container.querySelector('.variant-carousel-container').dataset.currentIndex = newIndex;

                dots.forEach((dot, i) => {
                    dot.classList.toggle('active', i === newIndex);
                });
            },
            openAddVariantModal,
            removeVariantFromSheetItem,
            openVariantDbSelector,
            openVariantAiGenerator,
            removeSheetItemLabel(sheetId, itemId, exerciseId, labelIndex) {
                const item = (state.sheetItems[sheetId] || []).find(i => i.id === itemId);
                if (!item) return;
                const currentLabels = (item.labels && item.labels[exerciseId]) || [];
                const updatedLabels = currentLabels.filter((_, index) => index !== labelIndex);
                updateSheetItemLabel(sheetId, itemId, exerciseId, updatedLabels);
            }
        };
        
        function startApp() {
            const { userId } = state;
            if (!userId) return;

            Object.keys(navs).forEach(key => {
                navs[key].forEach(nav => nav.onclick = () => { stopAllTimers(); navigate(key); });
            });
            
            document.getElementById('search-exercises').addEventListener('input', renderDbPage);
            document.getElementById('sort-exercises').addEventListener('change', renderDbPage);
            document.getElementById('search-history').addEventListener('input', renderHistoryList);
            document.getElementById('search-history-date').addEventListener('change', renderHistoryList);
            document.getElementById('search-sheets').addEventListener('input', renderSheetsPage);
            document.getElementById('add-category-btn').onclick = () => openCategoryModal();
            document.getElementById('add-container-btn').onclick = () => openContainerModal();
            document.getElementById('ai-generator-btn').onclick = () => openAiGeneratorModal();

            document.getElementById('workout-fab').onclick = openWorkoutSelectionModal;
            document.getElementById('workout-next-btn').onclick = workoutNextStep;
            document.getElementById('workout-prev-btn').onclick = workoutPrevStep;
            document.getElementById('end-workout-btn-header').onclick = endWorkout;
            document.getElementById('end-workout-btn-final').onclick = finishAndSaveWorkout;
            
            document.getElementById('history-tab-dashboard').onclick = () => {
                document.getElementById('history-tab-dashboard').classList.add('active');
                document.getElementById('history-tab-list').classList.remove('active');
                document.getElementById('dashboard-container').classList.remove('hidden');
                document.getElementById('history-list-container').classList.add('hidden');
            };
             document.getElementById('history-tab-list').onclick = () => {
                document.getElementById('history-tab-list').classList.add('active');
                document.getElementById('history-tab-dashboard').classList.remove('active');
                document.getElementById('history-list-container').classList.remove('hidden');
                document.getElementById('dashboard-container').classList.add('hidden');
            };

            const basePath = `/users/${userId}`;

            onSnapshot(query(collection(db, `${basePath}/categories`), orderBy("name")), s => { state.categories = s.docs.map(d=>({id:d.id,...d.data()})); render(); }, e => console.error("categories listener error:", e));
            onSnapshot(query(collection(db, `${basePath}/exercises`)), s => { state.exercises = s.docs.map(d=>({id:d.id,...d.data()})); render(); }, e => console.error("exercises listener error:", e));
            onSnapshot(query(collection(db, `${basePath}/exerciseHistory`), orderBy("timestamp", "desc")), s => { state.history = s.docs.map(d=>({id:d.id,...d.data()})); render(); }, e => console.error("exerciseHistory listener error:", e));
            onSnapshot(query(collection(db, `${basePath}/sheetContainers`), orderBy("order")), s => { state.sheetContainers = s.docs.map(d=>({id:d.id,...d.data()})); render(); }, e => console.error("sheetContainers listener error:", e));
            onSnapshot(query(collection(db, `${basePath}/workoutSessions`), orderBy("startTime", "desc")), s => { state.workoutSessions = s.docs.map(d=>({id:d.id,...d.data()})); render(); }, e => console.error("workoutSessions listener error:", e));
            
            onSnapshot(query(collection(db, `${basePath}/workoutSheets`), orderBy("order")), s => {
                const newSheets = s.docs.map(d=>({id:d.id,...d.data()}));
                const oldSheetIds = state.sheets.map(sh => sh.id);
                const newSheetIds = newSheets.map(sh => sh.id);

                // Unsubscribe from deleted sheets
                oldSheetIds.filter(id => !newSheetIds.includes(id)).forEach(id => {
                    if (state.listeners[id]) {
                        state.listeners[id](); // This is the unsubscribe function
                        delete state.listeners[id];
                        delete state.sheetItems[id];
                    }
                });

                newSheetIds.forEach(id => {
                    if (!state.listeners[id]) { 
                         state.listeners[id] = onSnapshot(query(collection(db, `${basePath}/workoutSheets/${id}/items`)), (snapshot) => {
                            state.sheetItems[id] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            // Rerender only if the current page is sheets or if in workout mode on this sheet
                            if(state.isWorkoutModeActive && state.workout?.sheetId === id) {
                                // Aggiorna dinamicamente i dati dell'allenamento in corso
                                state.workout.items = state.sheetItems[id]
                                    .filter(item => !item.isDeactivated)
                                    .sort((a,b) => a.order - b.order);
                                renderWorkoutStep(); 
                            } else if (state.currentPage === 'sheets') {
                                render();
                            }
                        }, e => console.error(`items listener error for sheet ${id}:`, e));
                    }
                });
                state.sheets = newSheets;
                render();
            }, e => console.error("workoutSheets listener error:", e));
            
            navigate(state.currentPage);
        }

        // --- LOGICA DI AUTENTICAZIONE E AVVIO ---

        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const authError = document.getElementById('auth-error');
        const passwordInput = document.getElementById('auth-password');
        const passwordToggle = document.getElementById('password-toggle');

        passwordToggle.onclick = () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            passwordToggle.querySelector('span').textContent = isPassword ? 'visibility' : 'visibility_off';
        };

        loginBtn.onclick = async () => {
            const email = document.getElementById('auth-email').value;
            const password = passwordInput.value;
            authError.textContent = '';
            if (!email || !password) {
                authError.textContent = "Inserisci email e password.";
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authError.textContent = "Credenziali non valide.";
                console.error("Login failed:", error);
            }
        };

        registerBtn.onclick = async () => {
            const email = document.getElementById('auth-email').value;
            const password = passwordInput.value;
             authError.textContent = '';
            if (!email || !password) {
                authError.textContent = "Inserisci email e password.";
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    authError.textContent = "Email già in uso.";
                } else if (error.code === 'auth/weak-password') {
                     authError.textContent = "Password troppo debole (min. 6 caratteri).";
                } else {
                    authError.textContent = "Errore durante la registrazione.";
                }
                console.error("Registration failed:", error);
            }
        };

        const handleLogout = () => {
            showConfirm('Conferma Logout', 'Sei sicuro di voler uscire?', async () => {
                try {
                    await signOut(auth);
                    window.location.reload();
                } catch (error) {
                    console.error("Logout failed:", error);
                    showToast("Errore durante il logout.", 'error');
                }
            });
        };

        document.getElementById('logout-btn').onclick = handleLogout;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.userId = user.uid;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                startApp();
            } else {
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

    </script>
</body>
</html>